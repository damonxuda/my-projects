{"ast":null,"code":"import{DEFAULT_TIMEOUT}from'../lib/constants';export default class Push{/**\n     * Initializes the Push\n     *\n     * @param channel The Channel\n     * @param event The event, for example `\"phx_join\"`\n     * @param payload The payload, for example `{user_id: 123}`\n     * @param timeout The push timeout in milliseconds\n     */constructor(channel,event){let payload=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};let timeout=arguments.length>3&&arguments[3]!==undefined?arguments[3]:DEFAULT_TIMEOUT;this.channel=channel;this.event=event;this.payload=payload;this.timeout=timeout;this.sent=false;this.timeoutTimer=undefined;this.ref='';this.receivedResp=null;this.recHooks=[];this.refEvent=null;}resend(timeout){this.timeout=timeout;this._cancelRefEvent();this.ref='';this.refEvent=null;this.receivedResp=null;this.sent=false;this.send();}send(){if(this._hasReceived('timeout')){return;}this.startTimeout();this.sent=true;this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()});}updatePayload(payload){this.payload=Object.assign(Object.assign({},this.payload),payload);}receive(status,callback){var _a;if(this._hasReceived(status)){callback((_a=this.receivedResp)===null||_a===void 0?void 0:_a.response);}this.recHooks.push({status,callback});return this;}startTimeout(){if(this.timeoutTimer){return;}this.ref=this.channel.socket._makeRef();this.refEvent=this.channel._replyEventName(this.ref);const callback=payload=>{this._cancelRefEvent();this._cancelTimeout();this.receivedResp=payload;this._matchReceive(payload);};this.channel._on(this.refEvent,{},callback);this.timeoutTimer=setTimeout(()=>{this.trigger('timeout',{});},this.timeout);}trigger(status,response){if(this.refEvent)this.channel._trigger(this.refEvent,{status,response});}destroy(){this._cancelRefEvent();this._cancelTimeout();}_cancelRefEvent(){if(!this.refEvent){return;}this.channel._off(this.refEvent,{});}_cancelTimeout(){clearTimeout(this.timeoutTimer);this.timeoutTimer=undefined;}_matchReceive(_ref){let{status,response}=_ref;this.recHooks.filter(h=>h.status===status).forEach(h=>h.callback(response));}_hasReceived(status){return this.receivedResp&&this.receivedResp.status===status;}}","map":{"version":3,"names":["DEFAULT_TIMEOUT","Push","constructor","channel","event","payload","arguments","length","undefined","timeout","sent","timeoutTimer","ref","receivedResp","recHooks","refEvent","resend","_cancelRefEvent","send","_hasReceived","startTimeout","socket","push","topic","join_ref","_joinRef","updatePayload","Object","assign","receive","status","callback","_a","response","_makeRef","_replyEventName","_cancelTimeout","_matchReceive","_on","setTimeout","trigger","_trigger","destroy","_off","clearTimeout","_ref","filter","h","forEach"],"sources":["/Users/damonxu/Documents/GitHub/my-projects/auth/node_modules/@supabase/realtime-js/src/lib/push.ts"],"sourcesContent":["import { DEFAULT_TIMEOUT } from '../lib/constants'\nimport type RealtimeChannel from '../RealtimeChannel'\n\nexport default class Push {\n  sent: boolean = false\n  timeoutTimer: number | undefined = undefined\n  ref: string = ''\n  receivedResp: {\n    status: string\n    response: { [key: string]: any }\n  } | null = null\n  recHooks: {\n    status: string\n    callback: Function\n  }[] = []\n  refEvent: string | null = null\n\n  /**\n   * Initializes the Push\n   *\n   * @param channel The Channel\n   * @param event The event, for example `\"phx_join\"`\n   * @param payload The payload, for example `{user_id: 123}`\n   * @param timeout The push timeout in milliseconds\n   */\n  constructor(\n    public channel: RealtimeChannel,\n    public event: string,\n    public payload: { [key: string]: any } = {},\n    public timeout: number = DEFAULT_TIMEOUT\n  ) {}\n\n  resend(timeout: number) {\n    this.timeout = timeout\n    this._cancelRefEvent()\n    this.ref = ''\n    this.refEvent = null\n    this.receivedResp = null\n    this.sent = false\n    this.send()\n  }\n\n  send() {\n    if (this._hasReceived('timeout')) {\n      return\n    }\n    this.startTimeout()\n    this.sent = true\n    this.channel.socket.push({\n      topic: this.channel.topic,\n      event: this.event,\n      payload: this.payload,\n      ref: this.ref,\n      join_ref: this.channel._joinRef(),\n    })\n  }\n\n  updatePayload(payload: { [key: string]: any }): void {\n    this.payload = { ...this.payload, ...payload }\n  }\n\n  receive(status: string, callback: Function) {\n    if (this._hasReceived(status)) {\n      callback(this.receivedResp?.response)\n    }\n\n    this.recHooks.push({ status, callback })\n    return this\n  }\n\n  startTimeout() {\n    if (this.timeoutTimer) {\n      return\n    }\n    this.ref = this.channel.socket._makeRef()\n    this.refEvent = this.channel._replyEventName(this.ref)\n\n    const callback = (payload: any) => {\n      this._cancelRefEvent()\n      this._cancelTimeout()\n      this.receivedResp = payload\n      this._matchReceive(payload)\n    }\n\n    this.channel._on(this.refEvent, {}, callback)\n\n    this.timeoutTimer = <any>setTimeout(() => {\n      this.trigger('timeout', {})\n    }, this.timeout)\n  }\n\n  trigger(status: string, response: any) {\n    if (this.refEvent)\n      this.channel._trigger(this.refEvent, { status, response })\n  }\n\n  destroy() {\n    this._cancelRefEvent()\n    this._cancelTimeout()\n  }\n\n  private _cancelRefEvent() {\n    if (!this.refEvent) {\n      return\n    }\n\n    this.channel._off(this.refEvent, {})\n  }\n\n  private _cancelTimeout() {\n    clearTimeout(this.timeoutTimer)\n    this.timeoutTimer = undefined\n  }\n\n  private _matchReceive({\n    status,\n    response,\n  }: {\n    status: string\n    response: Function\n  }) {\n    this.recHooks\n      .filter((h) => h.status === status)\n      .forEach((h) => h.callback(response))\n  }\n\n  private _hasReceived(status: string) {\n    return this.receivedResp && this.receivedResp.status === status\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}