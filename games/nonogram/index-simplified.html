<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数织游戏 - 简化版认证</title>
    <style>
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <h1>数织游戏 - 官方最佳实践测试</h1>

    <div id="debug" class="debug">
        <div>初始化中...</div>
    </div>

    <div id="auth-container"></div>
    <div id="game-container">游戏将在认证完成后加载...</div>

    <!-- Clerk SDK -->
    <script crossorigin="anonymous"
            data-clerk-publishable-key="${CLERK_PUBLISHABLE_KEY}"
            src="https://clerk.damonxuda.site/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
            type="text/javascript"></script>

    <!-- 游戏配置和存储 -->
    <script src="../shared/js/gameConfig.js"></script>
    <script src="../shared/js/smartGameStorage.js"></script>

    <script>
        let debugEl = document.getElementById('debug');

        function log(message) {
            console.log(message);
            debugEl.innerHTML += '<br>' + message;
        }

        // 按照官方最佳实践的简单实现
        window.addEventListener("load", async function () {
            log('📱 页面加载完成');

            if (!window.Clerk) {
                log('❌ Clerk SDK 未加载');
                return;
            }

            try {
                log('🔄 开始Clerk初始化...');
                await window.Clerk.load();
                log('✅ Clerk.load() 完成');

                // 官方推荐的简单检查方式
                if (window.Clerk.user) {
                    log('👤 用户已登录: ' + window.Clerk.user.id);
                    log('📧 邮箱: ' + (window.Clerk.user.primaryEmailAddress?.emailAddress || 'N/A'));

                    // 测试存储系统
                    testStorage(true);
                } else {
                    log('❌ 用户未登录');

                    // 测试存储系统（游客模式）
                    testStorage(false);
                }

                // 创建简单的认证UI
                createAuthUI();

            } catch (error) {
                log('❌ Clerk初始化失败: ' + error.message);
            }
        });

        function testStorage(isLoggedIn) {
            try {
                const storage = new SmartNonogramStorage();
                const userStatus = storage.isUserLoggedIn();
                log('🔍 存储系统检测用户状态: ' + (userStatus ? '已登录' : '游客'));
                log('🎯 预期状态: ' + (isLoggedIn ? '已登录' : '游客'));

                if (userStatus === isLoggedIn) {
                    log('✅ 用户状态检测正确');
                } else {
                    log('❌ 用户状态检测错误');
                }
            } catch (error) {
                log('❌ 存储系统错误: ' + error.message);
            }
        }

        function createAuthUI() {
            const container = document.getElementById('auth-container');

            if (window.Clerk.user) {
                container.innerHTML = `
                    <h2>欢迎，${window.Clerk.user.firstName || '用户'}！</h2>
                    <button onclick="signOut()">登出</button>
                `;
            } else {
                container.innerHTML = `
                    <h2>请登录</h2>
                    <button onclick="signIn()">登录</button>
                `;
            }
        }

        function signIn() {
            window.Clerk.openSignIn();
        }

        function signOut() {
            window.Clerk.signOut();
        }
    </script>
</body>
</html>