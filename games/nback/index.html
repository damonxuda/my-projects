<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="双重N-Back记忆训练 - 提升工作记忆和智力">

    <title>N-Back记忆训练</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Title */
        .title {
            text-align: center;
            margin-bottom: 30px;
        }

        .title h1 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* N-Level Display */
        .n-level-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .n-level-label {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .n-level-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .n-grid {
            background: rgba(129, 247, 53, 0.9);
            color: #333;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 10px;
            font-size: 24px;
            font-weight: bold;
            width: 55px;
            height: 55px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Game Info */
        .game-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-info-left {
            display: flex;
            gap: 20px;
        }

        .info-item {
            font-size: 16px;
        }

        .info-value {
            font-weight: bold;
            color: #ffd700;
        }

        /* Save Toggle */
        .save-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dc3545;
            transition: .4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #28a745;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Game Board */
        .game-board {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 360px;
            margin: 0 auto;
        }

        .cell {
            aspect-ratio: 1;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        /* Letter Display for Silent Mode */
        .letter-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #667eea;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .letter-display.show {
            opacity: 1;
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #5cb85c);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* Controls */
        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .key-hints {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .key-hint {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex: 1;
            margin: 0 10px;
        }

        .key-hint h4 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .key-hint p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 可点击按键样式 */
        .key-button {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transition: all 0.15s ease;
        }

        .key-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .key-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .key-button.pressed {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .start-button {
            display: block;
            width: 200px;
            margin: 0 auto;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .start-button:active {
            transform: translateY(0);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 15px;
            padding: 0;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h4 {
            margin: 0;
            font-size: 22px;
            color: white;
        }

        .close {
            color: rgba(255, 255, 255, 0.8);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            line-height: 1;
        }

        .close:hover {
            color: white;
        }

        .modal-body {
            padding: 25px;
            color: white;
        }

        .modal-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .modal-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-body li {
            margin-bottom: 8px;
        }

        .modal-body a {
            color: #ffd700;
            text-decoration: underline;
        }

        .modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .modal-body th,
        .modal-body td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-body th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            text-align: right;
        }

        .modal-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Difficulty Selection Buttons (for main screen) */
        .difficulty-btn-main {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

        .difficulty-btn-main small {
            display: block;
            font-size: 12px;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.8;
        }

        .difficulty-btn-main:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn-main.selected {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .difficulty-btn-main.recommended {
            border-color: #00ff00;
            position: relative;
        }

        .difficulty-btn-main.recommended::after {
            content: "推荐";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #00ff00;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Difficulty Selection Buttons (for modal - legacy) */
        .difficulty-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

        .difficulty-btn small {
            display: block;
            font-size: 12px;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.8;
        }

        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn.selected {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .difficulty-btn.recommended {
            border-color: #00ff00;
            position: relative;
        }

        .difficulty-btn.recommended::after {
            content: "推荐";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #00ff00;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1;
            overflow: hidden;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s ease;
        }

        .dropdown-content a:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .title h1 {
                font-size: 24px;
            }

            .game-info {
                flex-direction: column;
                gap: 15px;
            }

            .game-info-left {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .key-hints {
                /* 保持左右排列，不改为上下 */
                flex-direction: row;
            }

            .key-hint {
                margin: 0 5px;
            }

            .grid-container {
                max-width: 300px;
            }

            .letter-display {
                font-size: 80px;
            }
        }
    </style>
</head>

<body>
    <!-- Difficulty Selection Screen (shown first) -->
    <div id="difficulty-screen" class="full-screen-overlay">
        <div class="container">
            <div class="header">
                <a href="../index.html" class="back-btn">← 返回</a>
            </div>

            <div class="title">
                <h1>N-Back记忆训练</h1>
            </div>

            <div class="controls" style="max-width: 600px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 30px;">选择起始难度</h2>

                <p id="last-level-info-main" style="text-align: center; margin-bottom: 30px; font-size: 18px;"></p>

                <div style="margin: 30px 0;">
                    <label style="display: block; margin-bottom: 15px; font-weight: bold; text-align: center; font-size: 18px;">难度级别（N-Back）：</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button class="difficulty-btn-main" data-level="1">N=1<br><small>入门</small></button>
                        <button class="difficulty-btn-main" data-level="2">N=2<br><small>初级</small></button>
                        <button class="difficulty-btn-main" data-level="3">N=3<br><small>中级</small></button>
                        <button class="difficulty-btn-main" data-level="4">N=4<br><small>进阶</small></button>
                        <button class="difficulty-btn-main" data-level="5">N=5<br><small>高级</small></button>
                        <button class="difficulty-btn-main" data-level="6">N=6<br><small>专家</small></button>
                        <button class="difficulty-btn-main" data-level="7">N=7<br><small>大师</small></button>
                    </div>
                </div>

                <div style="margin: 30px 0; padding: 20px; background: rgba(255, 255, 255, 0.15); border-radius: 12px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <label style="font-size: 18px; font-weight: bold; margin: 0;">语音模式：</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="audio-mode-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p style="margin: 10px 0 0 0; text-align: center; font-size: 14px; opacity: 0.9;">
                        开启后会播放字母语音，关闭则在屏幕上显示字母
                    </p>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                    <p style="margin: 0; font-size: 16px; line-height: 1.8;">
                        <strong>说明：</strong>例如N=2表示记住2步之前的方块位置和字母。<br>
                        游戏会根据你的表现自动调整难度。<br>
                        <strong>模式：</strong>默认使用方块位置+视觉字母（纯视觉），语音模式使用方块位置+声音（双模态）。
                    </p>
                </div>

                <button id="start-training-btn" class="start-button" style="margin-top: 30px;">开始训练</button>

                <div style="text-align: center; margin-top: 20px;">
                    <a href="#" data-modal="howToPlayModal" style="color: rgba(255,255,255,0.8); text-decoration: underline;">查看游戏说明</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen (shown after difficulty selection) -->
    <div id="game-screen" style="display: none;">

    <!-- Header -->
    <div class="header">
        <a href="#" id="back-to-difficulty-btn" class="back-btn">← 返回</a>
        <div class="dropdown">
            <button class="menu-btn">菜单 ▼</button>
            <div class="dropdown-content">
                <a href="#" data-modal="howToPlayModal">游戏说明</a>
                <a href="#" id="progress-link">训练记录</a>
                <a href="#" data-modal="aboutModal">关于</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Title -->
        <div class="title">
            <h1>N-Back记忆训练</h1>
        </div>

        <!-- N-Level Display -->
        <div class="n-level-container">
            <div class="n-level-label" id="current-n-display">当前难度：N=1</div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <div class="game-info-left">
                <div class="info-item">
                    回合：<span class="info-value" id="session-number">1 / 20</span>
                </div>
                <div class="info-item">
                    得分：<span class="info-value" id="score-text">0</span>
                </div>
            </div>
            <div class="save-toggle-container">
                <span>保存进度：</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="save-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Game Board -->
        <div class="game-board">
            <div class="grid-container">
                <div id="top-left" class="cell"></div>
                <div id="top-middle" class="cell"></div>
                <div id="top-right" class="cell"></div>
                <div id="middle-left" class="cell"></div>
                <div id="middle" class="cell"></div>
                <div id="middle-right" class="cell"></div>
                <div id="bottom-left" class="cell"></div>
                <div id="bottom-middle" class="cell"></div>
                <div id="bottom-right" class="cell"></div>
            </div>
            <div id="letter-display" class="letter-display"></div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar" id="prog-bar"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="key-hints">
                <div class="key-hint key-button" id="left-hand-feedback" data-key="a">
                    <h4>A</h4>
                    <p>方块位置相同</p>
                </div>
                <div class="key-hint key-button" id="right-hand-feedback" data-key="l">
                    <h4>L</h4>
                    <p>字母相同</p>
                </div>
            </div>
            <button id="start-button" class="start-button" value="Start">开始</button>
        </div>
    </div>

    </div> <!-- End of #game-screen -->

    <!-- Difficulty Selection Modal (Legacy - will be removed) -->
    <div class="modal" id="difficultyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>选择起始难度</h4>
            </div>
            <div class="modal-body">
                <p id="last-level-info" style="margin-bottom: 20px; font-size: 16px;"></p>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">难度级别（N-Back）：</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button class="difficulty-btn" data-level="1">N=1<br><small>入门</small></button>
                        <button class="difficulty-btn" data-level="2">N=2<br><small>初级</small></button>
                        <button class="difficulty-btn" data-level="3">N=3<br><small>中级</small></button>
                        <button class="difficulty-btn" data-level="4">N=4<br><small>进阶</small></button>
                        <button class="difficulty-btn" data-level="5">N=5<br><small>高级</small></button>
                        <button class="difficulty-btn" data-level="6">N=6<br><small>专家</small></button>
                        <button class="difficulty-btn" data-level="7">N=7<br><small>大师</small></button>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                        <strong>说明：</strong>例如N=2表示记住2步之前的位置和字母。<br>
                        游戏会根据你的表现自动调整难度。
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="start-training-button" class="modal-button">开始训练</button>
            </div>
        </div>
    </div>

    <!-- Score Modal -->
    <div class="modal" id="scoreModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>回合完成！</h4>
            </div>
            <div class="modal-body">
                <p id="next-level-info">下一级别：</p>
                <p id="correct-audio-results">听觉正确率：</p>
                <p id="correct-visual-results">视觉正确率：</p>
            </div>
            <div class="modal-footer">
                <button id="continue-button" class="modal-button" value="Continue">继续</button>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progressModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>训练历史</h4>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <table id="progress-score-table">
                    <tr>
                        <th>#</th>
                        <th>日期</th>
                        <th>平均N级别</th>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button class="modal-button" data-dismiss="modal">确定</button>
            </div>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div class="modal" id="howToPlayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>游戏说明</h4>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>当你按下开始按钮后，应用会显示一个方块并播放一个字母的音频。记住方块出现的位置和字母。几秒钟后，另一个方块出现并播放另一个字母。也要记住这些。</p>

                <p>游戏默认从1-back级别开始（显示在顶部）。例如，2-back级别意味着你需要记住字母是否重复，或方块是否出现在2次之前的位置。示例：</p>
                <ol>
                    <li>右上角，字母'F'</li>
                    <li>右下角，字母'G'</li>
                    <li>右上角，字母'S'</li>
                    <li>底部中间，字母'G'</li>
                </ol>

                <p>在开始的N个"区块"你不需要做任何事情（N是你的当前级别）。但从第N+1个区块开始，你需要判断它是否与N步之前的位置或字母（或两者）匹配。以此类推。</p>

                <p>如果位置匹配，按键盘上的'A'；如果字母匹配，按'L'；如果两者都匹配，同时按两个键。</p>

                <p>从上面的例子来看，当区块3出现时，位置与区块1匹配（右上角），但字母不匹配。所以，按'A'。对于区块4，位置与区块2不匹配，但字母匹配，所以按'L'。记住区块3和4以继续游戏。</p>

                <p>每个回合有20个区块。在回合结束时，如果你表现良好，级别会增加（N+1）。这样，你需要记住字母/方块是否与更早之前显示的内容匹配。级别可以根据你的表现增加或减少。</p>

                <p>一次完整的训练包括20个回合。完成整个训练以查看你的结果，你可以通过切换保存进度开关来选择保存它们。</p>

                <p><strong>注意：</strong>这是一个有难度的游戏。一开始，可能很难按下正确的键。但请放心，研究对象在刚开始时也是如此。然而，经过足够的练习，研究对象的表现有所改善。</p>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>关于</h4>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p><em>"双重N-Back训练是一个应用程序，通过每天的训练，可能会提高一个人的智力。"</em></p>

                <p>这个应用程序是Jaeggi, S., Buschkuehl, M., Jonides, J. 和 Perrig, W. (2008)研究中使用的双重N-Back应用程序的复制品。<cite>《美国国家科学院院刊》</cite>，105(19)，第6829-6833页。</p>

                <p>该应用程序是<a href="http://www.soakyourhead.com/dual-n-back.aspx" target="_blank">原始Silverlight版本</a>的JavaScript转换版本（<a href="https://github.com/Poc275/NBack" target="_blank">源代码</a>）。随着大多数现代浏览器对Silverlight支持的减少，这个转换版本将帮助用户继续使用双重N-Back训练。</p>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio src="audio/letter1.mp3" id="letter1" preload="auto"></audio>
    <audio src="audio/letter2.mp3" id="letter2" preload="auto"></audio>
    <audio src="audio/letter3.mp3" id="letter3" preload="auto"></audio>
    <audio src="audio/letter4.mp3" id="letter4" preload="auto"></audio>
    <audio src="audio/letter5.mp3" id="letter5" preload="auto"></audio>
    <audio src="audio/letter6.mp3" id="letter6" preload="auto"></audio>
    <audio src="audio/letter7.mp3" id="letter7" preload="auto"></audio>
    <audio src="audio/letter8.mp3" id="letter8" preload="auto"></audio>

    <!-- JavaScript -->
    <script src="js/jquery.js"></script>
    <script src="js/Consonant.js"></script>
    <script src="js/SquarePosition.js"></script>
    <script src="js/TargetKind.js"></script>
    <script src="js/TrialResult.js"></script>
    <script src="js/Page.js"></script>
    <script src="js/Score.js"></script>
    <script src="js/Block.js"></script>
    <script src="js/BlockCreator.js"></script>
    <script src="js/Trial.js"></script>
    <script src="js/App.js"></script>
    <script src="js/History.js"></script>

    <script>
        // 难度选择功能
        var selectedDifficulty = 1; // 默认N=1
        var lastSavedLevel = null;
        var audioMode = false; // 语音模式，默认关闭（使用视觉模式）

        // 从localStorage读取上次的N级别
        function getLastLevel() {
            if (storageAvailable('localStorage')) {
                var lastLevel = localStorage.getItem('nback-last-level');
                return lastLevel ? parseInt(lastLevel) : null;
            }
            return null;
        }

        // 保存当前N级别
        function saveCurrentLevel(level) {
            if (storageAvailable('localStorage')) {
                localStorage.setItem('nback-last-level', level.toString());
            }
        }

        // 读取语音模式设置
        function getAudioMode() {
            if (storageAvailable('localStorage')) {
                var savedMode = localStorage.getItem('nback-audio-mode');
                // 默认为false（视觉模式），除非用户明确开启了语音模式
                return savedMode === 'true';
            }
            return false;
        }

        // 保存语音模式设置
        function saveAudioMode(mode) {
            if (storageAvailable('localStorage')) {
                localStorage.setItem('nback-audio-mode', mode.toString());
            }
        }

        // 初始化难度选择界面
        function initializeDifficultyScreen() {
            lastSavedLevel = getLastLevel();
            var infoText = '';

            if (lastSavedLevel !== null) {
                infoText = '上次训练难度：N=' + lastSavedLevel + ' | 推荐从上次难度继续';
                selectedDifficulty = lastSavedLevel;
            } else {
                infoText = '这是你的第一次训练，推荐从 N=1 开始';
                selectedDifficulty = 1;
            }

            document.getElementById('last-level-info-main').textContent = infoText;

            // 设置按钮状态
            document.querySelectorAll('.difficulty-btn-main').forEach(function(btn) {
                var level = parseInt(btn.getAttribute('data-level'));
                btn.classList.remove('selected', 'recommended');

                if (level === selectedDifficulty) {
                    btn.classList.add('selected');
                    if (lastSavedLevel !== null && level === lastSavedLevel) {
                        btn.classList.add('recommended');
                    }
                }
            });

            // 设置语音模式开关状态
            audioMode = getAudioMode();
            document.getElementById('audio-mode-toggle').checked = audioMode;

            // 显示难度选择界面
            document.getElementById('difficulty-screen').style.display = 'block';
            document.getElementById('game-screen').style.display = 'none';
        }

        // 语音模式开关监听
        document.getElementById('audio-mode-toggle').addEventListener('change', function() {
            audioMode = this.checked;
            saveAudioMode(audioMode);
        });

        // 难度按钮点击事件（主屏幕）
        document.querySelectorAll('.difficulty-btn-main').forEach(function(btn) {
            btn.addEventListener('click', function() {
                selectedDifficulty = parseInt(this.getAttribute('data-level'));
                document.querySelectorAll('.difficulty-btn-main').forEach(function(b) {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        // 开始训练按钮（主屏幕）
        document.getElementById('start-training-btn').addEventListener('click', function() {
            // 隐藏难度选择界面，显示游戏界面
            document.getElementById('difficulty-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            // 设置静音模式全局变量（audioMode=false表示静音/视觉模式）
            window.nbackSilentMode = !audioMode;

            // 更新按键提示文字
            if (audioMode) {
                document.querySelector('#right-hand-feedback p').textContent = '字母相同';
            } else {
                document.querySelector('#right-hand-feedback p').textContent = '显示字母相同';
            }

            // 设置起始N级别
            if (window.pageInstance) {
                window.pageInstance._starting_N = selectedDifficulty;
                window.pageInstance._n = selectedDifficulty;
                DisplayN(selectedDifficulty);

                // 预加载音频文件（在语音模式下）
                if (audioMode) {
                    window.pageInstance.preloadAudio();
                }
            }

            // 自动开始游戏
            setTimeout(function() {
                var startBtn = document.getElementById('start-button');
                startBtn.value = "Pause";
                startBtn.textContent = "暂停";
                // 触发游戏开始
                window.pageInstance.initialWait = new Timer(window.pageInstance.Start_Training, 675);
            }, 100);
        });

        // 页面加载时初始化难度选择界面
        window.addEventListener('load', function() {
            initializeDifficultyScreen();
        });

        // 触摸/点击按键处理
        document.querySelectorAll('.key-button').forEach(function(button) {
            // 模拟键盘按键的函数
            function simulateKeyPress(key) {
                // 创建并触发keyup事件
                var event = new KeyboardEvent('keyup', {
                    key: key,
                    code: key === 'a' ? 'KeyA' : 'KeyL',
                    bubbles: true,
                    cancelable: true
                });
                document.dispatchEvent(event);

                // 添加视觉反馈
                button.classList.add('pressed');
                setTimeout(function() {
                    button.classList.remove('pressed');
                }, 150);
            }

            // 点击事件（桌面和移动端都支持）
            button.addEventListener('click', function(e) {
                e.preventDefault();
                var key = this.getAttribute('data-key');
                simulateKeyPress(key);
            });

            // 触摸事件（移动端优化，防止双击缩放）
            button.addEventListener('touchstart', function(e) {
                e.preventDefault(); // 防止触发click事件
                var key = this.getAttribute('data-key');
                simulateKeyPress(key);
            }, { passive: false });
        });

        // Modal handling
        document.querySelectorAll('[data-modal]').forEach(function(element) {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                var modalId = this.getAttribute('data-modal');
                document.getElementById(modalId).classList.add('show');
            });
        });

        document.querySelectorAll('[data-dismiss="modal"]').forEach(function(element) {
            element.addEventListener('click', function() {
                this.closest('.modal').classList.remove('show');
            });
        });

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // Override continue button text for Chinese
        document.getElementById('continue-button').addEventListener('click', function() {
            setTimeout(function() {
                var btn = document.getElementById('continue-button');
                if (btn.value === "Reset") {
                    btn.textContent = "重置";
                } else if (btn.value === "Continue") {
                    btn.textContent = "继续";
                }
            }, 10);
        });

        // 返回难度选择界面
        document.getElementById('back-to-difficulty-btn').addEventListener('click', function(e) {
            e.preventDefault();
            // 隐藏游戏界面，显示难度选择界面
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('difficulty-screen').style.display = 'block';

            // 重置游戏状态
            if (window.pageInstance) {
                window.pageInstance._playingGame = false;
                // 重置开始按钮
                var startBtn = document.getElementById('start-button');
                startBtn.value = "Start";
                startBtn.textContent = "开始";
            }
        });
    </script>
</body>

</html>
