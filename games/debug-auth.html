<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆè®¤è¯çŠ¶æ€è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ¸¸æˆè®¤è¯çŠ¶æ€è°ƒè¯•é¢æ¿</h1>

    <div class="debug-panel">
        <h3>ğŸŒ åŸºæœ¬ç¯å¢ƒä¿¡æ¯</h3>
        <div id="basic-info"></div>
    </div>

    <div class="debug-panel">
        <h3>ğŸ” Clerkè®¤è¯çŠ¶æ€</h3>
        <div id="clerk-status"></div>
        <button onclick="checkClerkStatus()">ğŸ”„ åˆ·æ–°ClerkçŠ¶æ€</button>
    </div>

    <div class="debug-panel">
        <h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…</h3>
        <div id="user-details"></div>
    </div>

    <div class="debug-panel">
        <h3>ğŸ® æ¸¸æˆå­˜å‚¨çŠ¶æ€</h3>
        <div id="storage-status"></div>
        <button onclick="testStorageConnection()">ğŸ§ª æµ‹è¯•å­˜å‚¨è¿æ¥</button>
    </div>

    <div class="debug-panel">
        <h3>ğŸ’¾ æœ¬åœ°æ•°æ®</h3>
        <div id="local-data"></div>
        <button onclick="showLocalData()">ğŸ“‚ æ˜¾ç¤ºæœ¬åœ°æ•°æ®</button>
    </div>

    <div class="debug-panel">
        <h3>â˜ï¸ äº‘ç«¯æ•°æ®æµ‹è¯•</h3>
        <div id="cloud-test"></div>
        <button onclick="testCloudConnection()">ğŸŒ æµ‹è¯•äº‘ç«¯è¿æ¥</button>
    </div>

    <!-- Clerk SDK -->
    <script crossorigin="anonymous" data-clerk-publishable-key="${CLERK_PUBLISHABLE_KEY}" src="https://clerk.damonxuda.site/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>

    <script>
        // åŸºæœ¬ä¿¡æ¯æ˜¾ç¤º
        function showBasicInfo() {
            const info = {
                'URL': window.location.href,
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Online': navigator.onLine,
                'Cookies Enabled': navigator.cookieEnabled,
                'Local Storage Available': typeof(Storage) !== "undefined",
                'Current Time': new Date().toISOString()
            };

            document.getElementById('basic-info').innerHTML = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
        }

        // æ£€æŸ¥ClerkçŠ¶æ€
        async function checkClerkStatus() {
            const statusDiv = document.getElementById('clerk-status');
            let html = '';

            try {
                html += `<strong>Clerkå¯¹è±¡å­˜åœ¨:</strong> <span class="${window.Clerk ? 'status-ok' : 'status-error'}">${!!window.Clerk}</span><br>`;

                if (window.Clerk) {
                    html += `<strong>Clerkå·²åŠ è½½:</strong> <span class="${window.Clerk.loaded ? 'status-ok' : 'status-warning'}">${window.Clerk.loaded}</span><br>`;
                    html += `<strong>ç”¨æˆ·å¯¹è±¡å­˜åœ¨:</strong> <span class="${window.Clerk.user ? 'status-ok' : 'status-error'}">${!!window.Clerk.user}</span><br>`;
                    html += `<strong>Sessionå­˜åœ¨:</strong> <span class="${window.Clerk.session ? 'status-ok' : 'status-error'}">${!!window.Clerk.session}</span><br>`;

                    if (window.Clerk.user) {
                        html += `<strong>ç”¨æˆ·ID:</strong> ${window.Clerk.user.id}<br>`;
                        html += `<strong>é‚®ç®±:</strong> ${window.Clerk.user.emailAddresses?.[0]?.emailAddress || 'N/A'}<br>`;
                    }

                    if (window.Clerk.session) {
                        html += `<strong>Session ID:</strong> ${window.Clerk.session.id}<br>`;
                        try {
                            const token = await window.Clerk.session.getToken();
                            html += `<strong>JWT Token:</strong> <span class="status-ok">âœ… è·å–æˆåŠŸ (${token ? token.substring(0, 20) + '...' : 'null'})</span><br>`;
                        } catch (error) {
                            html += `<strong>JWT Token:</strong> <span class="status-error">âŒ è·å–å¤±è´¥: ${error.message}</span><br>`;
                        }
                    }
                }

                // æ£€æŸ¥localStorageä¸­çš„è®¤è¯ä¿¡æ¯
                try {
                    const clerkEnv = localStorage.getItem('__clerk_environment');
                    if (clerkEnv) {
                        const envData = JSON.parse(clerkEnv);
                        html += `<strong>LocalStorageè®¤è¯:</strong> <span class="status-ok">âœ… å­˜åœ¨</span><br>`;
                        html += `<strong>LSç”¨æˆ·ID:</strong> ${envData.user?.id || 'N/A'}<br>`;
                        html += `<strong>LS Session ID:</strong> ${envData.session?.id || 'N/A'}<br>`;
                    } else {
                        html += `<strong>LocalStorageè®¤è¯:</strong> <span class="status-error">âŒ ä¸å­˜åœ¨</span><br>`;
                    }
                } catch (error) {
                    html += `<strong>LocalStorageæ£€æŸ¥:</strong> <span class="status-error">âŒ è§£æå¤±è´¥</span><br>`;
                }

            } catch (error) {
                html += `<strong>æ£€æŸ¥è¿‡ç¨‹å‡ºé”™:</strong> <span class="status-error">${error.message}</span><br>`;
            }

            statusDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
        function showUserDetails() {
            const detailsDiv = document.getElementById('user-details');

            if (window.Clerk && window.Clerk.user) {
                const user = window.Clerk.user;
                const details = {
                    'User ID': user.id,
                    'First Name': user.firstName,
                    'Last Name': user.lastName,
                    'Email Addresses': user.emailAddresses?.map(e => e.emailAddress).join(', '),
                    'Primary Email': user.primaryEmailAddress?.emailAddress,
                    'Created At': user.createdAt,
                    'Updated At': user.updatedAt,
                    'Public Metadata': JSON.stringify(user.publicMetadata, null, 2),
                    'Private Metadata': JSON.stringify(user.privateMetadata, null, 2)
                };

                detailsDiv.innerHTML = Object.entries(details)
                    .map(([key, value]) => `<strong>${key}:</strong><br><div class="code-block">${value || 'N/A'}</div>`)
                    .join('');
            } else {
                detailsDiv.innerHTML = '<span class="status-error">âŒ ç”¨æˆ·æœªç™»å½•æˆ–Clerkæœªåˆå§‹åŒ–</span>';
            }
        }

        // æµ‹è¯•å­˜å‚¨è¿æ¥
        async function testStorageConnection() {
            const statusDiv = document.getElementById('storage-status');
            let html = '';

            try {
                // æ£€æŸ¥SmartGameStorageæ˜¯å¦å­˜åœ¨
                html += `<strong>SmartGameStorageç±»:</strong> <span class="${window.SmartNonogramStorage ? 'status-ok' : 'status-error'}">${!!window.SmartNonogramStorage}</span><br>`;

                if (window.SmartNonogramStorage) {
                    const storage = new window.SmartNonogramStorage();

                    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                    const isLoggedIn = storage.isUserLoggedIn();
                    html += `<strong>å­˜å‚¨ç³»ç»Ÿè¯†åˆ«ç™»å½•çŠ¶æ€:</strong> <span class="${isLoggedIn ? 'status-ok' : 'status-error'}">${isLoggedIn}</span><br>`;

                    const userId = storage.getUserId();
                    html += `<strong>å­˜å‚¨ç³»ç»Ÿè·å–ç”¨æˆ·ID:</strong> ${userId || 'N/A'}<br>`;

                    const syncStatus = storage.getSyncStatus();
                    html += `<strong>åŒæ­¥çŠ¶æ€:</strong><br><div class="code-block">${JSON.stringify(syncStatus, null, 2)}</div>`;

                    // å°è¯•åŠ è½½è¿›åº¦
                    try {
                        const progress = await storage.loadProgress();
                        html += `<strong>è¿›åº¦åŠ è½½:</strong> <span class="status-ok">âœ… æˆåŠŸ</span><br>`;
                        html += `<strong>å½“å‰è¿›åº¦:</strong><br><div class="code-block">${JSON.stringify(progress, null, 2)}</div>`;
                    } catch (error) {
                        html += `<strong>è¿›åº¦åŠ è½½:</strong> <span class="status-error">âŒ å¤±è´¥: ${error.message}</span><br>`;
                    }
                }

            } catch (error) {
                html += `<strong>å­˜å‚¨æµ‹è¯•å‡ºé”™:</strong> <span class="status-error">${error.message}</span><br>`;
            }

            statusDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºæœ¬åœ°æ•°æ®
        function showLocalData() {
            const dataDiv = document.getElementById('local-data');
            let html = '';

            try {
                const gameKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('nonogram')) {
                        gameKeys.push(key);
                    }
                }

                html += `<strong>æ¸¸æˆç›¸å…³æœ¬åœ°å­˜å‚¨é”®:</strong> ${gameKeys.length} ä¸ª<br>`;

                gameKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const data = JSON.parse(value);
                        html += `<strong>${key}:</strong><br><div class="code-block">${JSON.stringify(data, null, 2)}</div>`;
                    } catch (error) {
                        html += `<strong>${key}:</strong> <span class="status-error">è§£æå¤±è´¥</span><br>`;
                    }
                });

                if (gameKeys.length === 0) {
                    html += '<span class="status-warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ¸¸æˆç›¸å…³çš„æœ¬åœ°æ•°æ®</span>';
                }

            } catch (error) {
                html += `<strong>æœ¬åœ°æ•°æ®æ£€æŸ¥å‡ºé”™:</strong> <span class="status-error">${error.message}</span><br>`;
            }

            dataDiv.innerHTML = html;
        }

        // æµ‹è¯•äº‘ç«¯è¿æ¥
        async function testCloudConnection() {
            const testDiv = document.getElementById('cloud-test');
            let html = '';

            try {
                // æ£€æŸ¥Supabaseè¿æ¥
                html += `<strong>createGameSupabaseClientå‡½æ•°:</strong> <span class="${window.createGameSupabaseClient ? 'status-ok' : 'status-error'}">${!!window.createGameSupabaseClient}</span><br>`;

                if (window.createGameSupabaseClient) {
                    const supabase = window.createGameSupabaseClient();
                    html += `<strong>Supabaseå®¢æˆ·ç«¯:</strong> <span class="status-ok">âœ… åˆ›å»ºæˆåŠŸ</span><br>`;

                    // å°è¯•æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ•°æ®
                    if (window.Clerk && window.Clerk.user) {
                        const userId = window.Clerk.user.id;
                        html += `<strong>æŸ¥è¯¢ç”¨æˆ·æ•°æ®:</strong> ${userId}<br>`;

                        try {
                            const { data, error } = await supabase
                                .from('game_progress')
                                .select('*')
                                .eq('user_id', userId)
                                .eq('game', 'nonogram');

                            if (error) {
                                html += `<strong>äº‘ç«¯æŸ¥è¯¢:</strong> <span class="status-error">âŒ å¤±è´¥: ${error.message}</span><br>`;
                            } else {
                                html += `<strong>äº‘ç«¯æŸ¥è¯¢:</strong> <span class="status-ok">âœ… æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} æ¡è®°å½•</span><br>`;
                                if (data.length > 0) {
                                    html += `<strong>äº‘ç«¯æ•°æ®:</strong><br><div class="code-block">${JSON.stringify(data, null, 2)}</div>`;
                                }
                            }
                        } catch (queryError) {
                            html += `<strong>äº‘ç«¯æŸ¥è¯¢:</strong> <span class="status-error">âŒ å¼‚å¸¸: ${queryError.message}</span><br>`;
                        }
                    } else {
                        html += `<strong>äº‘ç«¯æŸ¥è¯¢:</strong> <span class="status-warning">âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æŸ¥è¯¢</span><br>`;
                    }
                }

            } catch (error) {
                html += `<strong>äº‘ç«¯æµ‹è¯•å‡ºé”™:</strong> <span class="status-error">${error.message}</span><br>`;
            }

            testDiv.innerHTML = html;
        }

        // åˆå§‹åŒ–
        async function init() {
            showBasicInfo();

            // ç­‰å¾…ClerkåŠ è½½
            if (window.Clerk) {
                try {
                    await window.Clerk.load({
                        domain: window.location.hostname,
                        cookieDomain: window.location.hostname.startsWith('localhost') ? 'localhost' : `.${window.location.hostname}`,
                        cookiePath: '/',
                        sessionSyncing: true
                    });
                } catch (error) {
                    console.warn('ClerkåŠ è½½å¤±è´¥:', error);
                }
            }

            // å»¶è¿Ÿæ£€æŸ¥å„ç§çŠ¶æ€
            setTimeout(() => {
                checkClerkStatus();
                showUserDetails();
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- åŠ è½½æ¸¸æˆå­˜å‚¨ç³»ç»Ÿ -->
    <script src="shared/js/gameConfig.js"></script>
    <script src="shared/js/smartGameStorage.js"></script>
</body>
</html>