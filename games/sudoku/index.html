<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0"
    />
    <title>数独游戏 - 子杰之家</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg" />
    <link rel="icon" type="image/x-icon" href="../../favicon.ico" />
    
    <!-- PWA 支持 -->
    <meta name="theme-color" content="#667eea" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="数独" />
    
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
      }
      
      .game-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 1rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      /* 顶部工具栏 */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
      }
      
      .header .back-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1.2rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
      }
      
      /* Only apply hover effects on non-touch devices to prevent sticky hover on mobile */
      @media (hover: hover) and (pointer: fine) {
        .header .back-btn:hover {
          background: rgba(255, 255, 255, 0.3);
        }
      }
      
      .header .title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }
      
      .header .timer {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        min-width: 80px;
        text-align: center;
      }
      
      /* 控制面板 */
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
      }
      
      .difficulty-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .difficulty-selector label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      .difficulty-selector select {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        color: white;
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
      }
      
      .difficulty-selector select option {
        background: #667eea;
        color: white;
      }

      /* 关卡信息显示 */
      .game-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .level-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }
      
      .btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }
      
      @media (hover: hover) and (pointer: fine) {
        .btn:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-1px);
        }
      }

      .btn:active {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }
      
      .btn.primary {
        background: rgba(76, 175, 80, 0.8);
        border-color: rgba(76, 175, 80, 1);
      }
      
      @media (hover: hover) and (pointer: fine) {
        .btn.primary:hover {
          background: rgba(76, 175, 80, 1);
        }
      }
      
      /* 数独棋盘 */
      .board-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1rem;
      }
      
      .sudoku-board {
        background: rgba(255, 255, 255, 0.95);
        border: 3px solid rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
        gap: 1px;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1;
        margin-bottom: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .cell {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      /* 3x3宫格边框 */
      .cell:nth-child(3n) {
        border-right: 2px solid rgba(0, 0, 0, 0.3);
      }
      
      .cell:nth-child(n+19):nth-child(-n+27),
      .cell:nth-child(n+46):nth-child(-n+54) {
        border-bottom: 2px solid rgba(0, 0, 0, 0.3);
      }
      
      /* 单元格状态 */
      .cell.fixed {
        background: #f5f5f5;
        color: #333;
        font-weight: 700;
        cursor: default;
      }
      
      .cell.selected {
        background: rgba(103, 126, 234, 0.8);
        color: white;
        transform: scale(1.05);
        z-index: 10;
        box-shadow: 0 0 0 2px rgba(103, 126, 234, 1);
      }
      
      .cell.conflict {
        background: rgba(244, 67, 54, 0.8);
        color: white;
        animation: shake 0.3s ease-in-out;
      }
      
      .cell.highlight {
        background: rgba(103, 126, 234, 0.3);
      }
      
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
      }
      
      /* 数字输入面板 */
      .number-pad {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        width: 100%;
        max-width: 400px;
        margin-bottom: 1rem;
      }
      
      .num-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
        padding: 1rem 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      @media (hover: hover) and (pointer: fine) {
        .num-btn:hover {
          background: rgba(255, 255, 255, 0.4);
          border-color: rgba(255, 255, 255, 0.6);
          transform: translateY(-2px);
        }
      }

      .num-btn:active {
        background: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.6);
        transform: translateY(-2px);
      }
      
      .num-btn.erase {
        background: rgba(244, 67, 54, 0.6);
        border-color: rgba(244, 67, 54, 0.8);
        font-size: 1rem;
        grid-column: span 2;
      }
      
      @media (hover: hover) and (pointer: fine) {
        .num-btn.erase:hover {
          background: rgba(244, 67, 54, 0.8);
        }
      }
      
      /* 游戏完成提示 */
      .game-complete {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .complete-dialog {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        color: #333;
        max-width: 300px;
        width: 90%;
      }
      
      .complete-dialog h2 {
        margin: 0 0 1rem 0;
        color: #4caf50;
      }
      
      .complete-dialog .time {
        font-size: 1.5rem;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 1rem;
      }
      
      .complete-dialog .actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }
      
      .complete-dialog .btn {
        color: #333;
        border-color: #ddd;
      }
      
      /* 响应式设计 */
      @media (max-width: 480px) {
        .game-container {
          padding: 0.5rem;
        }
        
        .header .title {
          font-size: 1.2rem;
        }
        
        .controls {
          flex-direction: column;
          gap: 0.5rem;
          padding: 1rem;
        }
        
        .difficulty-selector,
        .action-buttons {
          width: 100%;
          justify-content: center;
        }
        
        .cell {
          font-size: 1rem;
        }
        
        .num-btn {
          font-size: 1.2rem;
          padding: 0.8rem 0.3rem;
        }
      }
      
      @media (max-width: 360px) {
        .sudoku-board {
          max-width: 320px;
        }
        
        .cell {
          font-size: 0.9rem;
        }
        
        .num-btn {
          font-size: 1.1rem;
          padding: 0.7rem 0.2rem;
        }
      }
      
      /* 加载动画 */
      .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
      }
      
      .loading.show {
        display: block;
      }
      
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- 顶部工具栏 -->
      <div class="header">
        <a href="../" class="back-btn">← 返回</a>
        <h1 class="title">数独</h1>
        <div class="timer" id="timer">00:00</div>
      </div>
      
      <!-- 控制面板 -->
      <div class="controls">
        <div class="game-info" id="level-info" style="display: none;">
          <div class="level-badge">
            <span id="current-difficulty">中等</span> - 第<span id="current-level">1</span>关
          </div>
        </div>
        
        <div class="difficulty-selector" id="difficulty-selector">
          <label for="difficulty">难度:</label>
          <select id="difficulty">
            <option value="easy">简单</option>
            <option value="medium" selected>中等</option>
            <option value="hard">困难</option>
            <option value="expert">专家</option>
            <option value="master">大师</option>
          </select>
        </div>
        
        <div class="action-buttons">
          <button class="btn" id="levels-btn">选择关卡</button>
          <button class="btn" id="restart-btn">重开</button>
          <button class="btn primary" id="new-game-btn">随机题目</button>
        </div>
      </div>
      
      <!-- 游戏棋盘区域 -->
      <div class="board-container">
        <div class="sudoku-board" id="sudoku-board">
          <!-- 81个格子将由JavaScript生成 -->
        </div>
        
        <!-- 数字输入面板 -->
        <div class="number-pad">
          <button class="num-btn" data-num="1">1</button>
          <button class="num-btn" data-num="2">2</button>
          <button class="num-btn" data-num="3">3</button>
          <button class="num-btn" data-num="4">4</button>
          <button class="num-btn" data-num="5">5</button>
          <button class="num-btn" data-num="6">6</button>
          <button class="num-btn" data-num="7">7</button>
          <button class="num-btn" data-num="8">8</button>
          <button class="num-btn" data-num="9">9</button>
          <button class="num-btn erase" data-action="erase">清除</button>
        </div>
      </div>
    </div>
    
    <!-- 加载动画 -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>
    
    <!-- 游戏完成对话框 -->
    <div class="game-complete" id="game-complete">
      <div class="complete-dialog">
        <h2>🎉 恭喜完成！</h2>
        <div class="time" id="complete-time">--:--</div>
        <div class="stars" id="complete-stars" style="font-size: 2rem; margin: 1rem 0;">
          ★★★
        </div>
        <div class="level-complete-info" id="level-complete-info" style="display: none;">
          <p>关卡进度已保存</p>
        </div>
        <div class="actions">
          <button class="btn" onclick="closeCompleteDialog()">继续</button>
          <button class="btn" id="next-level-btn" onclick="goToNextLevel()" style="display: none;">下一关</button>
          <button class="btn primary" onclick="startNewGame()">再来一局</button>
        </div>
      </div>
    </div>
    
    <!-- Clerk SDK for SSO with fallback -->
    <script>
      // Clerk SDK加载检测和备用方案
      function loadClerkSDK() {
        const primaryScript = document.createElement('script');
        primaryScript.crossOrigin = 'anonymous';
        primaryScript.setAttribute('data-clerk-publishable-key', '${CLERK_PUBLISHABLE_KEY}');
        primaryScript.src = 'https://clerk.damonxuda.site/npm/@clerk/clerk-js@latest/dist/clerk.browser.js';
        primaryScript.type = 'text/javascript';

        primaryScript.onload = function() {
          console.log('✅ Clerk SDK加载成功 (主CDN)');
        };

        primaryScript.onerror = function() {
          console.warn('⚠️ 主Clerk CDN加载失败，尝试备用CDN...');

          // 尝试备用CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.crossOrigin = 'anonymous';
          fallbackScript.setAttribute('data-clerk-publishable-key', '${CLERK_PUBLISHABLE_KEY}');
          fallbackScript.src = 'https://unpkg.com/@clerk/clerk-js@latest/dist/clerk.browser.js';
          fallbackScript.type = 'text/javascript';

          fallbackScript.onload = function() {
            console.log('✅ Clerk SDK加载成功 (备用CDN)');
          };

          fallbackScript.onerror = function() {
            console.error('❌ 所有Clerk CDN都无法加载，将以离线模式继续');
            // 触发离线模式初始化
            window.clerkInitialized = true;
            window.dispatchEvent(new CustomEvent('clerkReady'));
          };

          document.head.appendChild(fallbackScript);
        };

        document.head.appendChild(primaryScript);
      }

      // 延迟加载给页面更多时间初始化
      setTimeout(loadClerkSDK, 100);
    </script>

    <!-- Clerk 初始化和登录UI -->
    <script>
      window.clerkInitialized = false;
      window.addEventListener('load', async () => {

        // 传统Clerk初始化流程（作为备用）
        if (window.Clerk) {
          try {
            await window.Clerk.load();
            console.log('✅ Clerk 初始化成功');
            console.log('   - Clerk loaded:', window.Clerk.loaded);

            // 详细的Clerk状态调试信息
            console.log('🔍 详细的Clerk状态调试:');
            console.log('   - window.Clerk:', window.Clerk);
            console.log('   - window.Clerk.loaded:', window.Clerk ? window.Clerk.loaded : 'N/A');
            console.log('   - window.Clerk.user:', window.Clerk ? window.Clerk.user : 'N/A');
            console.log('   - window.Clerk.session:', window.Clerk ? window.Clerk.session : 'N/A');
            console.log('   - Current URL:', window.location.href);
            console.log('   - Document.domain:', document.domain);
            console.log('   - Cookies:', document.cookie);

            // 等待用户状态完全恢复（重要：跨页面跳转时需要时间恢复状态）
            let retryCount = 0;
            const maxRetries = 10; // 最多重试10次
            const checkUserState = async () => {
              console.log(`🔄 检查用户状态 (尝试 ${retryCount + 1}/${maxRetries})`);
              console.log('   - User:', window.Clerk.user ? `${window.Clerk.user.id}` : 'Not logged in');
              console.log('   - Session:', window.Clerk.session ? 'Active' : 'None');
              console.log('   - Session ID:', window.Clerk.session ? window.Clerk.session.id : 'N/A');

              if (window.Clerk.user || retryCount >= maxRetries - 1) {
                // 用户状态已恢复或达到最大重试次数
                console.log('✅ 用户状态检查完成');
                if (window.Clerk.user) {
                  console.log('👤 最终用户信息:');
                  console.log('   - User ID:', window.Clerk.user.id);
                  console.log('   - Email:', window.Clerk.user.primaryEmailAddress?.emailAddress);
                  console.log('   - First Name:', window.Clerk.user.firstName);
                } else {
                  console.log('❌ 最终结果：用户未登录，将以游客模式继续');
                }

                // 标记Clerk已初始化
                window.clerkInitialized = true;

                // 触发自定义事件通知游戏可以开始初始化
                window.dispatchEvent(new CustomEvent('clerkReady'));
              } else {
                // 继续等待用户状态恢复
                retryCount++;
                setTimeout(checkUserState, 200); // 每200ms检查一次
              }
            };

            // 开始检查用户状态
            await checkUserState();

          } catch (error) {
            console.error('❌ Clerk 初始化失败:', error);
            // 即使失败也要让游戏继续，以游客模式运行
            window.clerkInitialized = true;
            window.dispatchEvent(new CustomEvent('clerkReady'));
          }
        } else {
          console.error('❌ Clerk SDK 未加载');
          // 没有Clerk SDK也要让游戏继续
          window.clerkInitialized = true;
          window.dispatchEvent(new CustomEvent('clerkReady'));
        }
      });

    </script>

    <!-- Supabase 客户端 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- 环境变量配置 -->
    <script>
      // 设置 Supabase 环境变量
      window.REACT_APP_SUPABASE_URL = 'https://qeedsnqbudbogqpcerqb.supabase.co';
      window.REACT_APP_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlZWRzbnFidWRib2dxcGNlcnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMxOTIsImV4cCI6MjA3MDAzOTE5Mn0.-hWnQwcpvXjX1dMJcNaQC7AUp8jYC9ozhgjFzSHeAGo';
    </script>

    <!-- 引入脚本 -->
    <script src="../shared/js/gameUtils.js"></script>
    <!-- Legacy auth modules commented out - using SmartGameStorage instead -->
    <!-- <script src="../shared/js/storage.js"></script> -->
    <!-- <script src="../shared/js/gameAuth.js"></script> -->
    <!-- <script src="../shared/js/authStorage.js"></script> -->

    <!-- 智能存储系统 -->
    <script src="../shared/js/gameConfig.js"></script>
    <script src="../shared/js/smartGameStorage.js"></script>
    <script src="../shared/js/smartGameStorage-edge-function.js"></script>
    <script src="sudoku.js"></script>
    <script src="game.js"></script>
  </body>
</html>