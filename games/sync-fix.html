<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏进度同步修复工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .danger-btn {
            background: #dc3545;
        }
        .danger-btn:hover {
            background: #c82333;
        }
        .success-btn {
            background: #28a745;
        }
        .success-btn:hover {
            background: #218838;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 游戏进度同步修复工具</h1>
        <p>这个工具可以帮助修复跨设备游戏进度同步问题</p>

        <div class="status-section">
            <h3>📋 当前状态检查</h3>
            <div id="status-info">⏳ 正在检查...</div>
            <button onclick="checkStatus()">🔄 重新检查</button>
        </div>

        <div class="status-section">
            <h3>🛠️ 修复选项</h3>

            <h4>选项1: 强制从云端加载进度</h4>
            <p>如果电脑上有正确的进度，这将从云端加载最新进度到手机</p>
            <button onclick="forceLoadFromCloud()" id="load-btn">☁️ 从云端加载进度</button>

            <h4>选项2: 将当前进度上传到云端</h4>
            <p>如果手机上的进度是正确的，这将上传到云端覆盖电脑进度</p>
            <button onclick="forceSaveToCloud()" id="save-btn" class="danger-btn">📤 上传当前进度到云端</button>

            <h4>选项3: 手动账户切换</h4>
            <p>检查并切换到正确的用户账户</p>
            <button onclick="showAccountInfo()" id="account-btn">👤 显示账户信息</button>

            <h4>选项4: 清理重置</h4>
            <p>⚠️ 危险操作：清除本地数据并重新开始</p>
            <button onclick="resetGameData()" id="reset-btn" class="danger-btn">🗑️ 重置游戏数据</button>
        </div>

        <div class="status-section">
            <h3>📊 操作进度</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div id="operation-status">待命中...</div>
        </div>

        <div class="status-section">
            <h3>📝 操作日志</h3>
            <div class="code-block" id="operation-log" style="height: 200px; overflow-y: auto;">
                <div>🎮 游戏进度同步修复工具已就绪</div>
            </div>
        </div>
    </div>

    <!-- Clerk SDK -->
    <script crossorigin="anonymous" data-clerk-publishable-key="${CLERK_PUBLISHABLE_KEY}" src="https://clerk.damonxuda.site/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>

    <!-- 游戏存储系统 -->
    <script src="shared/js/gameConfig.js"></script>
    <script src="shared/js/smartGameStorage.js"></script>

    <script>
        let storage = null;
        let progress = 0;

        // 日志记录
        function log(message, type = 'info') {
            const logDiv = document.getElementById('operation-log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '📝';
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';

            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: ${color}">[${timestamp}] ${icon} ${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 更新进度条
        function updateProgress(percent, status) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('operation-status').textContent = status;
        }

        // 初始化
        async function init() {
            try {
                log('初始化Clerk认证系统...');
                await window.Clerk.load({
                    domain: window.location.hostname,
                    cookieDomain: window.location.hostname.startsWith('localhost') ? 'localhost' : `.${window.location.hostname}`,
                    cookiePath: '/',
                    sessionSyncing: true
                });

                log('初始化游戏存储系统...');
                storage = new window.SmartNonogramStorage();

                log('系统初始化完成', 'success');
                checkStatus();
            } catch (error) {
                log(`初始化失败: ${error.message}`, 'error');
            }
        }

        // 检查状态
        async function checkStatus() {
            updateProgress(10, '正在检查认证状态...');

            try {
                const statusDiv = document.getElementById('status-info');
                let html = '';

                // 检查认证状态
                const isLoggedIn = storage.isUserLoggedIn();
                const userId = storage.getUserId();
                const user = storage.getUser();

                html += `<strong>登录状态:</strong> <span class="${isLoggedIn ? 'status-ok' : 'status-error'}">${isLoggedIn ? '✅ 已登录' : '❌ 未登录'}</span><br>`;

                if (isLoggedIn) {
                    html += `<strong>用户ID:</strong> ${userId}<br>`;
                    html += `<strong>邮箱:</strong> ${user?.emailAddresses?.[0]?.emailAddress || 'N/A'}<br>`;
                    html += `<strong>用户名:</strong> ${user?.firstName || ''} ${user?.lastName || ''}<br>`;
                }

                updateProgress(30, '正在加载游戏进度...');

                // 检查本地进度
                let localProgress = null;
                try {
                    localProgress = await storage.loadProgress();
                    html += `<strong>本地进度:</strong> <span class="status-ok">✅ 已加载</span><br>`;
                    html += `<strong>Easy关卡:</strong> ${localProgress.easy?.current_level || 1} (完成 ${localProgress.easy?.completed_levels?.length || 0} 关)<br>`;
                } catch (error) {
                    html += `<strong>本地进度:</strong> <span class="status-error">❌ 加载失败</span><br>`;
                    log(`本地进度加载失败: ${error.message}`, 'error');
                }

                updateProgress(60, '正在检查云端数据...');

                // 检查云端数据
                if (isLoggedIn && window.createGameSupabaseClient) {
                    try {
                        const supabase = window.createGameSupabaseClient();
                        const { data, error } = await supabase
                            .from('game_progress')
                            .select('*')
                            .eq('user_id', userId)
                            .eq('game', 'nonogram');

                        if (error) {
                            html += `<strong>云端数据:</strong> <span class="status-error">❌ 查询失败: ${error.message}</span><br>`;
                        } else {
                            html += `<strong>云端数据:</strong> <span class="${data.length > 0 ? 'status-ok' : 'status-warning'}">${data.length > 0 ? '✅' : '⚠️'} ${data.length} 条记录</span><br>`;

                            if (data.length > 0) {
                                const cloudProgress = data[0].data;
                                html += `<strong>云端Easy关卡:</strong> ${cloudProgress.easy?.current_level || 1} (完成 ${cloudProgress.easy?.completed_levels?.length || 0} 关)<br>`;
                                html += `<strong>更新时间:</strong> ${new Date(data[0].updated_at).toLocaleString()}<br>`;

                                // 比较本地和云端进度
                                if (localProgress && cloudProgress) {
                                    const localLevel = localProgress.easy?.current_level || 1;
                                    const cloudLevel = cloudProgress.easy?.current_level || 1;

                                    if (localLevel !== cloudLevel) {
                                        html += `<strong>进度差异:</strong> <span class="status-warning">⚠️ 本地(${localLevel}) vs 云端(${cloudLevel})</span><br>`;
                                    } else {
                                        html += `<strong>进度同步:</strong> <span class="status-ok">✅ 已同步</span><br>`;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        html += `<strong>云端连接:</strong> <span class="status-error">❌ 连接失败: ${error.message}</span><br>`;
                        log(`云端连接失败: ${error.message}`, 'error');
                    }
                }

                statusDiv.innerHTML = html;
                updateProgress(100, '状态检查完成');
                log('状态检查完成', 'success');

            } catch (error) {
                document.getElementById('status-info').innerHTML = `<span class="status-error">❌ 检查失败: ${error.message}</span>`;
                log(`状态检查失败: ${error.message}`, 'error');
                updateProgress(0, '检查失败');
            }
        }

        // 强制从云端加载
        async function forceLoadFromCloud() {
            if (!storage.isUserLoggedIn()) {
                log('用户未登录，无法从云端加载', 'error');
                return;
            }

            updateProgress(0, '开始从云端加载...');
            log('开始强制从云端加载进度...');

            try {
                updateProgress(25, '连接云端...');
                const cloudProgress = await storage.loadFromCloud('progress');

                if (!cloudProgress) {
                    log('云端没有找到进度数据', 'warning');
                    updateProgress(100, '云端无数据');
                    return;
                }

                updateProgress(50, '下载进度数据...');
                log('从云端获取到进度数据');

                updateProgress(75, '保存到本地...');
                await storage.saveToLocal('progress', cloudProgress);

                updateProgress(100, '加载完成');
                log('云端进度已成功加载到本地', 'success');

                // 刷新页面以应用新进度
                setTimeout(() => {
                    if (confirm('进度已更新，是否刷新页面查看？')) {
                        window.location.reload();
                    }
                }, 1000);

            } catch (error) {
                log(`从云端加载失败: ${error.message}`, 'error');
                updateProgress(0, '加载失败');
            }
        }

        // 强制保存到云端
        async function forceSaveToCloud() {
            if (!storage.isUserLoggedIn()) {
                log('用户未登录，无法保存到云端', 'error');
                return;
            }

            if (!confirm('⚠️ 这将用当前本地进度覆盖云端数据，确定继续吗？')) {
                return;
            }

            updateProgress(0, '开始上传到云端...');
            log('开始强制保存到云端...');

            try {
                updateProgress(25, '加载本地进度...');
                const localProgress = await storage.loadFromLocal('progress');

                if (!localProgress) {
                    log('本地没有进度数据可上传', 'warning');
                    updateProgress(100, '本地无数据');
                    return;
                }

                updateProgress(50, '上传进度数据...');
                const success = await storage.saveToCloud('progress', localProgress);

                if (success) {
                    updateProgress(100, '上传完成');
                    log('本地进度已成功保存到云端', 'success');
                } else {
                    throw new Error('保存到云端失败');
                }

            } catch (error) {
                log(`保存到云端失败: ${error.message}`, 'error');
                updateProgress(0, '上传失败');
            }
        }

        // 显示账户信息
        async function showAccountInfo() {
            try {
                const user = storage.getUser();
                const userId = storage.getUserId();

                if (!user) {
                    log('未找到用户信息', 'error');
                    return;
                }

                log('=== 账户信息 ===');
                log(`用户ID: ${userId}`);
                log(`邮箱: ${user.emailAddresses?.[0]?.emailAddress || 'N/A'}`);
                log(`姓名: ${user.firstName || ''} ${user.lastName || ''}`);
                log(`创建时间: ${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}`);
                log('===============');

                // 检查是否是正确的账户
                const email = user.emailAddresses?.[0]?.emailAddress;
                if (email === 'damon_xuda@163.com') {
                    log('✅ 当前使用的是主账户 (damon_xuda@163.com)', 'success');
                } else if (email === 'damon.xu@gmail.com') {
                    log('⚠️ 当前使用的是副账户 (damon.xu@gmail.com)', 'warning');
                    log('建议切换到主账户 damon_xuda@163.com 以同步电脑进度', 'warning');
                } else {
                    log(`ℹ️ 当前账户: ${email}`, 'info');
                }

            } catch (error) {
                log(`获取账户信息失败: ${error.message}`, 'error');
            }
        }

        // 重置游戏数据
        async function resetGameData() {
            if (!confirm('⚠️ 这将清除所有本地游戏数据，不可恢复！确定继续吗？')) {
                return;
            }

            if (!confirm('最后确认：真的要重置所有游戏数据吗？')) {
                return;
            }

            updateProgress(0, '开始重置...');
            log('开始重置游戏数据...');

            try {
                updateProgress(50, '清除本地数据...');

                // 清除localStorage中的游戏数据
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('nonogram')) {
                        keys.push(key);
                    }
                }

                keys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`已删除: ${key}`);
                });

                updateProgress(100, '重置完成');
                log('游戏数据已重置', 'success');

                setTimeout(() => {
                    if (confirm('重置完成，是否刷新页面？')) {
                        window.location.reload();
                    }
                }, 1000);

            } catch (error) {
                log(`重置失败: ${error.message}`, 'error');
                updateProgress(0, '重置失败');
            }
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>