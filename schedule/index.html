<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0"
    />

    <!-- ç¤¾äº¤åª’ä½“åˆ†äº«é¢„è§ˆ -->
    <meta property="og:title" content="å­æ°æš‘å‡è¯¾ç¨‹å®‰æ’" />
    <meta
      property="og:description"
      content="2025å¹´æš‘å‡å­¦ä¹ è®¡åˆ’ï¼Œè¯¾ç¨‹å®‰æ’ä¸€ç›®äº†ç„¶ï¼Œæ”¯æŒåœ¨çº¿ç¼–è¾‘å’Œè¯¾ç¨‹æé†’"
    />
    <meta
      property="og:image"
      content="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=1200&h=630&fit=crop&auto=format"
    />
    <meta
      property="og:url"
      content="https://damonxuda.github.io/course-schedule/"
    />
    <meta property="og:type" content="website" />

    <!-- å¾®ä¿¡åˆ†äº«ä¼˜åŒ– -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="å­æ°æš‘å‡è¯¾ç¨‹å®‰æ’" />
    <meta
      name="twitter:description"
      content="2025å¹´æš‘å‡å­¦ä¹ è®¡åˆ’ï¼Œè¯¾ç¨‹å®‰æ’ä¸€ç›®äº†ç„¶ï¼Œæ”¯æŒåœ¨çº¿ç¼–è¾‘å’Œè¯¾ç¨‹æé†’"
    />
    <meta
      name="twitter:image"
      content="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=1200&h=630&fit=crop&auto=format"
    />

    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="è¯¾ç¨‹è¡¨" />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text x='50' y='60' font-size='50' text-anchor='middle' fill='white'>ğŸ“š</text></svg>"
    />
    <link
      rel="manifest"
      href="data:application/json,{
        'name': 'æš‘å‡è¯¾ç¨‹æ—¥å†',
        'short_name': 'è¯¾ç¨‹è¡¨',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#667eea',
        'theme_color': '#667eea',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'><rect width=\\'100\\' height=\\'100\\' fill=\\'%23667eea\\'/><text x=\\'50\\' y=\\'60\\' font-size=\\'50\\' text-anchor=\\'middle\\' fill=\\'white\\'>ğŸ“š</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            }
        ]
    }"
    />
    <title>æš‘å‡è¯¾ç¨‹æ—¥å†æé†’</title>

    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/styles.css?v=20250909" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“ å­æ°æš‘å‡è¯¾ç¨‹å®‰æ’</h1>
        <div class="current-date" id="currentDate"></div>
      </div>

      <div class="main-content">
        <div class="calendar-nav">
          <button class="nav-btn" id="prevBtn">â† å‰ä¸€å¤©</button>
          <div class="date-display" id="displayDate"></div>
          <button class="nav-btn" id="nextBtn">åä¸€å¤© â†’</button>
        </div>

        <div class="today-schedule">
          <div class="schedule-title">ä»Šæ—¥è¯¾ç¨‹å®‰æ’</div>
          <div id="scheduleContent"></div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalCourses">0</div>
            <div class="stat-label">ä»Šæ—¥è¯¾ç¨‹æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="courseHours">0</div>
            <div class="stat-label">è¯¾ç¨‹å°æ—¶æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="categoryCount">0</div>
            <div class="stat-label">è¯¾ç¨‹ç±»å‹</div>
          </div>
        </div>

        <div class="bottom-buttons">
          <button class="edit-toggle" onclick="handleEditClick()">
            âœï¸ ç¼–è¾‘è¯¾ç¨‹å®‰æ’
          </button>
          <a href="../" class="home-btn">
            ğŸ  è¿”å›é¦–é¡µ
          </a>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘å™¨ç•Œé¢ -->
    <div class="editor-overlay" id="editorOverlay">
      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-title">ğŸ“… è¯¾ç¨‹å®‰æ’ç¼–è¾‘å™¨</div>
          <button class="close-btn" onclick="handleCloseEditor()">Ã—</button>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ“… é€‰æ‹©æ—¥æœŸ</label>
          <input
            type="date"
            class="form-input"
            id="editDate"
            onchange="handleLoadDateCourses()"
          />
        </div>

        <div class="course-list" id="courseList">
          <!-- å½“å‰æ—¥æœŸçš„è¯¾ç¨‹åˆ—è¡¨ -->
        </div>

        <div class="form-group">
          <label class="form-label">â° è¯¾ç¨‹æ—¶é—´</label>
          <div class="time-inputs">
            <input
              type="time"
              class="form-input"
              id="startTime"
              placeholder="å¼€å§‹æ—¶é—´"
            />
            <div class="time-separator">è‡³</div>
            <input
              type="time"
              class="form-input"
              id="endTime"
              placeholder="ç»“æŸæ—¶é—´"
            />
          </div>
          <div class="quick-times">
            <button
              class="quick-time-btn"
              onclick="handleSetQuickTime('09:00', '11:00')"
            >
              09:00-11:00
            </button>
            <button
              class="quick-time-btn"
              onclick="handleSetQuickTime('13:00', '15:00')"
            >
              13:00-15:00
            </button>
            <button
              class="quick-time-btn"
              onclick="handleSetQuickTime('15:30', '17:30')"
            >
              15:30-17:30
            </button>
            <button
              class="quick-time-btn"
              onclick="handleSetQuickTime('19:00', '21:00')"
            >
              19:00-21:00
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ“š è¯¾ç¨‹åç§°</label>
          <input
            type="text"
            class="form-input"
            id="courseName"
            placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°"
          />
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ¯ è¯¾ç¨‹ç±»å‹</label>
          <select class="form-select" id="courseCategory">
            <option value="è‹±è¯­">è‹±è¯­</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="ä½“é”»">ä½“é”»</option>
            <option value="ä¸­æ–‡">ä¸­æ–‡</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ“ å¤‡æ³¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
          <textarea
            class="form-textarea"
            id="courseNote"
            placeholder="æ·»åŠ è¯¾ç¨‹å¤‡æ³¨æˆ–è¯´æ˜"
          ></textarea>
        </div>

        <button class="btn-primary" onclick="handleSaveCourse()" id="saveBtn">
          â• æ·»åŠ è¯¾ç¨‹
        </button>

        <div class="editor-actions">
          <button class="btn-secondary" onclick="handleCloseEditor()">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥Supabaseåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- Clerk SDK -->
    <script crossorigin="anonymous" data-clerk-publishable-key="${CLERK_PUBLISHABLE_KEY}" src="https://clerk.damonxuda.site/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>

    <!-- ç¯å¢ƒå˜é‡è®¾ç½® -->
    <script>
        window.REACT_APP_SUPABASE_URL = "${REACT_APP_SUPABASE_URL}";
        window.REACT_APP_SUPABASE_ANON_KEY = "${REACT_APP_SUPABASE_ANON_KEY}";
        window.CLERK_PUBLISHABLE_KEY = "${CLERK_PUBLISHABLE_KEY}";
    </script>

    <!-- Schedule æ¨¡å—è®¤è¯åˆå§‹åŒ– -->
    <script>
      // Scheduleæ¨¡å—è®¤è¯ç³»ç»Ÿ - åŸºäºgamesæ¨¡å—çš„Clerk-JSè®¤è¯æ–¹æ¡ˆ
      (function() {
        'use strict';

        console.log('ğŸ“… Scheduleæ¨¡å—è®¤è¯ç³»ç»Ÿå¼€å§‹åˆå§‹åŒ–');

        let isAuthChecked = false;
        let authRetryCount = 0;
        const MAX_AUTH_RETRIES = 3;

        // è®¤è¯æ£€æŸ¥ç±»
        class ScheduleAuth {
          constructor() {
            this.userCache = null;
            this.tokenCache = null;
          }

          // ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸ç›´æ¥ä»Clerkè·å–ï¼‰
          async getUserFromCache() {
            try {
              // ç­–ç•¥1: ä»window.mockClerkUserè·å–ï¼ˆReactåº”ç”¨è®¾ç½®çš„ï¼‰
              if (window.mockClerkUser && window.mockClerkUser.isAuthenticated) {
                console.log('ğŸ“… ä»mockClerkUserè·å–ç”¨æˆ·ä¿¡æ¯');
                this.userCache = window.mockClerkUser;
                return window.mockClerkUser;
              }

              // ç­–ç•¥2: ä»localStorageçš„__clerk_environmentè·å–
              const clerkEnv = localStorage.getItem('__clerk_environment');
              if (clerkEnv) {
                const envData = JSON.parse(clerkEnv);
                if (envData.user && envData.session) {
                  console.log('ğŸ“… ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯');
                  this.userCache = envData.user;
                  return envData.user;
                }
              }

              // ç­–ç•¥3: å¦‚æœClerkå·²åˆå§‹åŒ–ä¸”æœ‰ç”¨æˆ·ï¼Œè·å–ä½†ä¸ç›´æ¥ä½¿ç”¨
              if (window.Clerk && window.Clerk.user) {
                console.log('ğŸ“… ä»Clerkè·å–ç”¨æˆ·ä¿¡æ¯');
                this.userCache = window.Clerk.user;
                return window.Clerk.user;
              }

              return null;
            } catch (error) {
              console.error('âŒ è·å–ç¼“å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
              return null;
            }
          }

          // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
          async isSignedIn() {
            const user = await this.getUserFromCache();
            return !!user;
          }

          // é‡å®šå‘åˆ°ä¸»é¡µç™»å½•
          redirectToLogin() {
            console.log('ğŸ”„ é‡å®šå‘åˆ°ä¸»é¡µè¿›è¡Œç™»å½•');
            const currentUrl = encodeURIComponent(window.location.href);
            window.location.href = `/?auth=signin&redirect=${currentUrl}`;
          }
        }

        // åˆ›å»ºè®¤è¯å®ä¾‹
        const scheduleAuth = new ScheduleAuth();
        window.scheduleAuth = scheduleAuth; // æš´éœ²ç»™å…¶ä»–æ¨¡å—ä½¿ç”¨

        // è®¤è¯æ£€æŸ¥å‡½æ•°
        async function checkAuthentication() {
          try {
            console.log('ğŸ” å¼€å§‹è®¤è¯æ£€æŸ¥...');

            const isSignedIn = await scheduleAuth.isSignedIn();

            if (isSignedIn) {
              console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œå…è®¸è®¿é—®Scheduleæ¨¡å—');
              isAuthChecked = true;

              // æ˜¾ç¤ºä¸»è¦å†…å®¹
              const mainContent = document.querySelector('.container');
              if (mainContent) {
                mainContent.style.display = 'block';
              }

              // åˆå§‹åŒ–Scheduleåº”ç”¨
              if (typeof initializeScheduleApp === 'function') {
                initializeScheduleApp();
              }

              return true;
            } else {
              console.log('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œéœ€è¦é‡å®šå‘åˆ°ç™»å½•é¡µ');

              // å»¶è¿Ÿé‡å®šå‘ï¼Œç»™Clerkæ›´å¤šæ—¶é—´åˆå§‹åŒ–
              if (authRetryCount < MAX_AUTH_RETRIES) {
                authRetryCount++;
                console.log(`â° ç­‰å¾…è®¤è¯çŠ¶æ€æ›´æ–°... (${authRetryCount}/${MAX_AUTH_RETRIES})`);
                setTimeout(checkAuthentication, 1000);
                return false;
              } else {
                scheduleAuth.redirectToLogin();
                return false;
              }
            }
          } catch (error) {
            console.error('âŒ è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
            scheduleAuth.redirectToLogin();
            return false;
          }
        }

        // åˆå§‹åŒ–å‡½æ•°
        async function initializeAuth() {
          // å…ˆéšè—ä¸»è¦å†…å®¹
          const mainContent = document.querySelector('.container');
          if (mainContent) {
            mainContent.style.display = 'none';
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          const loadingDiv = document.createElement('div');
          loadingDiv.id = 'auth-loading';
          loadingDiv.innerHTML = `
            <div style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-family: -apple-system, BlinkMacSystemFont, sans-serif;
              z-index: 9999;
            ">
              <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“…</div>
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">è¯¾ç¨‹å®‰æ’</div>
                <div style="font-size: 0.9rem; opacity: 0.8;">æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€...</div>
              </div>
            </div>
          `;
          document.body.appendChild(loadingDiv);

          // ç­‰å¾…Clerkåˆå§‹åŒ–
          if (window.Clerk) {
            try {
              await window.Clerk.load({
                domain: window.location.hostname,
                cookieDomain: window.location.hostname.startsWith('localhost')
                  ? 'localhost'
                  : `.${window.location.hostname}`,
                cookiePath: '/',
                allowOrigins: [
                  window.location.origin,
                  `${window.location.protocol}//${window.location.hostname}`,
                  `${window.location.protocol}//${window.location.hostname}/schedule`,
                  `${window.location.protocol}//${window.location.hostname}/quiz`,
                  `${window.location.protocol}//${window.location.hostname}/admin`,
                  `${window.location.protocol}//${window.location.hostname}/videos`,
                  `${window.location.protocol}//${window.location.hostname}/games`
                ],
                sessionSyncing: true
              });

              console.log('âœ… Clerkåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
              console.warn('âš ï¸ Clerkåˆå§‹åŒ–å¤±è´¥ï¼Œä½†ç»§ç»­è®¤è¯æ£€æŸ¥:', error);
            }
          }

          // æ‰§è¡Œè®¤è¯æ£€æŸ¥
          const authResult = await checkAuthentication();

          // ç§»é™¤åŠ è½½çŠ¶æ€
          const loading = document.getElementById('auth-loading');
          if (loading) {
            loading.remove();
          }

          return authResult;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeAuth);
        } else {
          initializeAuth();
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        if (window.Clerk) {
          window.Clerk.addListener(({ user, session }) => {
            if (!isAuthChecked && (user || session)) {
              console.log('ğŸ”„ æ£€æµ‹åˆ°è®¤è¯çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°æ£€æŸ¥');
              checkAuthentication();
            }
          });
        }

      })();
    </script>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="js/config.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
