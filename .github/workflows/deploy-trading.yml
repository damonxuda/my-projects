name: Deploy Trading System

on:
  push:
    branches: [main]
    paths:
      - 'backend/lambda-trading-shared/**'
      - 'backend/lambda-cc-trading/**'
      - 'backend/lambda-stock-trading/**'
      - 'backend/lambda-test-finnhub/**'
      - '.github/workflows/deploy-trading.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy-trading-shared-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "ğŸ“¦ Installing dependencies for Lambda Layer..."
          npm install --production

          echo "âœ… Dependencies installed:"
          ls -la node_modules/ | head -20

      - name: Create Layer package
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "ğŸ“¦ Creating Lambda Layer package..."

          # åˆ›å»º Layer ç›®å½•ç»“æ„ï¼ˆå¿…é¡»æ˜¯ nodejs/ï¼‰
          mkdir -p layer/nodejs

          # å¤åˆ¶æ ¸å¿ƒä»£ç æ–‡ä»¶
          echo "Copying core modules..."
          cp llm-clients.mjs layer/nodejs/
          cp technical-indicators.mjs layer/nodejs/
          cp decision-parser.mjs layer/nodejs/
          cp portfolio-management.mjs layer/nodejs/
          cp utils.mjs layer/nodejs/
          cp index.mjs layer/nodejs/

          # å¤åˆ¶ package.json
          cp package.json layer/nodejs/

          # å¤åˆ¶ node_modules
          echo "Copying node_modules..."
          cp -r node_modules layer/nodejs/

          # æ‰“åŒ… Layer
          cd layer
          zip -r ../layer.zip nodejs/ -q
          cd ..

          echo "âœ… Layer package created:"
          ls -lh layer.zip
          echo "Package size: $(ls -lh layer.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish Lambda Layer
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "ğŸ“¤ Publishing Lambda Layer to AWS..."

          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name lambda-trading-shared \
            --description "Shared modules for trading systems (LLM clients, indicators, decision parser, utils)" \
            --zip-file fileb://layer.zip \
            --compatible-runtimes nodejs20.x \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Version' \
            --output text)

          echo "âœ… Published lambda-trading-shared Layer version: ${LAYER_VERSION}"

          # ä¿å­˜ Layer ARN åˆ°ç¯å¢ƒå˜é‡
          LAYER_ARN="arn:aws:lambda:${{ secrets.AWS_REGION }}:730335478220:layer:lambda-trading-shared:${LAYER_VERSION}"
          echo "LAYER_ARN=${LAYER_ARN}" >> $GITHUB_ENV
          echo "LAYER_VERSION=${LAYER_VERSION}" >> $GITHUB_ENV

          echo "ğŸ“Œ Layer ARN: ${LAYER_ARN}"

      - name: Update TRADING_CC_LAMBDA to use new Layer
        run: |
          echo "ğŸ”— Updating TRADING_CC_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_CC_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "â³ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "âœ… TRADING_CC_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Update TRADING_STOCK_LAMBDA to use new Layer
        run: |
          echo "ğŸ”— Updating TRADING_STOCK_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_STOCK_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "â³ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "âœ… TRADING_STOCK_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Lambda Layer Deployment Complete!"
          echo ""
          echo "ğŸ“¦ Layer Name: lambda-trading-shared"
          echo "ğŸ“Œ Layer ARN: ${LAYER_ARN}"
          echo "ğŸ”¢ Layer Version: ${LAYER_VERSION}"
          echo ""
          echo "âœ… Updated Functions:"
          echo "  - TRADING_CC_LAMBDA (Crypto Trading)"
          echo "  - TRADING_STOCK_LAMBDA (Stock Trading)"
          echo ""
          echo "ğŸ’¡ To update other functions manually, use:"
          echo "   aws lambda update-function-configuration \\"
          echo "     --function-name YOUR_FUNCTION_NAME \\"
          echo "     --layers \"${LAYER_ARN}\""

  deploy-trading-cc:
    runs-on: ubuntu-latest
    # Crypto trading lambda uses lambda-trading-shared Layer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package (code only, no node_modules)
        working-directory: ./backend/lambda-cc-trading
        run: |
          echo "ğŸ“¦ Creating TRADING_CC_LAMBDA package (Crypto Trading)..."
          echo "âš ï¸  Using lambda-trading-shared Layer for dependencies"

          # åªæ‰“åŒ…ä»£ç æ–‡ä»¶
          zip -r function.zip index.mjs -x "*.DS_Store" "node_modules/*" "*.zip"

          ls -lh function.zip
          echo "âœ… Package size: $(ls -lh function.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        working-directory: ./backend/lambda-cc-trading
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_KEY="lambda-deploy/TRADING_CC_LAMBDA-${TIMESTAMP}.zip"

          echo "ğŸ“¤ Uploading to S3: s3://damonxuda-projects/${S3_KEY}"
          aws s3 cp function.zip s3://damonxuda-projects/${S3_KEY}

          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Deploy to Lambda
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_PRO_API_KEY: ${{ secrets.GEMINI_PRO_API_KEY }}
          GEMINI_FLASH_API_KEY: ${{ secrets.GEMINI_FLASH_API_KEY }}
          CLAUDE_SONNET_API_KEY: ${{ secrets.CLAUDE_SONNET_API_KEY }}
          CLAUDE_HAIKU_API_KEY: ${{ secrets.CLAUDE_HAIKU_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸš€ Deploying TRADING_CC_LAMBDA (Crypto Trading)..."
          echo "ğŸ“¦ Using S3 key: ${{ env.S3_KEY }}"

          # æ›´æ–°å‡½æ•°ä»£ç 
          aws lambda update-function-code \
            --function-name TRADING_CC_LAMBDA \
            --s3-bucket damonxuda-projects \
            --s3-key ${{ env.S3_KEY }}

          # ç­‰å¾…å‡½æ•°æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA

          # æ›´æ–°ç¯å¢ƒå˜é‡ï¼ˆLambda Layer ç”± deploy-layer.yml ç®¡ç†ï¼‰
          echo "ğŸ”§ Updating environment variables..."
          aws lambda update-function-configuration \
            --function-name TRADING_CC_LAMBDA \
            --environment "Variables={GEMINI_API_KEY=${GEMINI_API_KEY},GEMINI_PRO_API_KEY=${GEMINI_PRO_API_KEY},GEMINI_FLASH_API_KEY=${GEMINI_FLASH_API_KEY},CLAUDE_SONNET_API_KEY=${CLAUDE_SONNET_API_KEY},CLAUDE_HAIKU_API_KEY=${CLAUDE_HAIKU_API_KEY},DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY},GROK_API_KEY=${GROK_API_KEY},OPENAI_API_KEY=${OPENAI_API_KEY},CRYPTOCOMPARE_API_KEY=${CRYPTOCOMPARE_API_KEY},COINGECKO_API_KEY=${COINGECKO_API_KEY},SUPABASE_URL=${SUPABASE_URL},SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}}"

          # ç­‰å¾…é…ç½®æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA

          echo "âœ… TRADING_CC_LAMBDA deployed successfully!"

  deploy-trading-stock:
    runs-on: ubuntu-latest
    # Stock trading lambda uses lambda-trading-shared Layer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package (code only, no node_modules)
        working-directory: ./backend/lambda-stock-trading
        run: |
          echo "ğŸ“¦ Creating TRADING_STOCK_LAMBDA package (Stock Trading)..."
          echo "âš ï¸  Using lambda-trading-shared Layer for dependencies"

          # åªæ‰“åŒ…ä»£ç æ–‡ä»¶
          zip -r function.zip index.mjs -x "*.DS_Store" "node_modules/*" "*.zip"

          ls -lh function.zip
          echo "âœ… Package size: $(ls -lh function.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        working-directory: ./backend/lambda-stock-trading
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_KEY="lambda-deploy/TRADING_STOCK_LAMBDA-${TIMESTAMP}.zip"

          echo "ğŸ“¤ Uploading to S3: s3://damonxuda-projects/${S3_KEY}"
          aws s3 cp function.zip s3://damonxuda-projects/${S3_KEY}

          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Deploy to Lambda
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_PRO_API_KEY: ${{ secrets.GEMINI_PRO_API_KEY }}
          GEMINI_FLASH_API_KEY: ${{ secrets.GEMINI_FLASH_API_KEY }}
          CLAUDE_SONNET_API_KEY: ${{ secrets.CLAUDE_SONNET_API_KEY }}
          CLAUDE_HAIKU_API_KEY: ${{ secrets.CLAUDE_HAIKU_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸš€ Deploying TRADING_STOCK_LAMBDA (Stock Trading)..."
          echo "ğŸ“¦ Using S3 key: ${{ env.S3_KEY }}"

          # æ›´æ–°å‡½æ•°ä»£ç 
          aws lambda update-function-code \
            --function-name TRADING_STOCK_LAMBDA \
            --s3-bucket damonxuda-projects \
            --s3-key ${{ env.S3_KEY }}

          # ç­‰å¾…å‡½æ•°æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA

          # æ›´æ–°ç¯å¢ƒå˜é‡ï¼ˆLambda Layer ç”± deploy-layer.yml ç®¡ç†ï¼‰
          echo "ğŸ”§ Updating environment variables..."
          aws lambda update-function-configuration \
            --function-name TRADING_STOCK_LAMBDA \
            --environment "Variables={GEMINI_API_KEY=${GEMINI_API_KEY},GEMINI_PRO_API_KEY=${GEMINI_PRO_API_KEY},GEMINI_FLASH_API_KEY=${GEMINI_FLASH_API_KEY},CLAUDE_SONNET_API_KEY=${CLAUDE_SONNET_API_KEY},CLAUDE_HAIKU_API_KEY=${CLAUDE_HAIKU_API_KEY},DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY},GROK_API_KEY=${GROK_API_KEY},OPENAI_API_KEY=${OPENAI_API_KEY},ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY},SUPABASE_URL=${SUPABASE_URL},SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}}"

          # ç­‰å¾…é…ç½®æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA

          echo "âœ… TRADING_STOCK_LAMBDA deployed successfully!"

  deploy-test-finnhub:
    runs-on: ubuntu-latest
    # Test Lambda for Finnhub API

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        working-directory: ./backend/lambda-test-finnhub
        run: |
          echo "ğŸ“¦ Creating TEST_FINNHUB_LAMBDA package..."

          # åªæ‰“åŒ…ä»£ç æ–‡ä»¶ï¼ˆè¿™ä¸ªæµ‹è¯• Lambda ä¸éœ€è¦ä¾èµ–ï¼‰
          zip -r function.zip index.mjs -x "*.DS_Store" "*.zip"

          ls -lh function.zip
          echo "âœ… Package size: $(ls -lh function.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        working-directory: ./backend/lambda-test-finnhub
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_KEY="lambda-deploy/TEST_FINNHUB_LAMBDA-${TIMESTAMP}.zip"

          echo "ğŸ“¤ Uploading to S3: s3://damonxuda-projects/${S3_KEY}"
          aws s3 cp function.zip s3://damonxuda-projects/${S3_KEY}

          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Check if Lambda function exists
        id: check_function
        run: |
          if aws lambda get-function --function-name TEST_FINNHUB_LAMBDA 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Lambda function TEST_FINNHUB_LAMBDA exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Lambda function TEST_FINNHUB_LAMBDA does not exist, will create"
          fi

      - name: Create Lambda function (if not exists)
        if: steps.check_function.outputs.exists == 'false'
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ğŸ†• Creating new Lambda function: TEST_FINNHUB_LAMBDA"

          aws lambda create-function \
            --function-name TEST_FINNHUB_LAMBDA \
            --runtime nodejs20.x \
            --role arn:aws:iam::730335478220:role/lambda-trading-role \
            --handler index.handler \
            --code S3Bucket=damonxuda-projects,S3Key=${{ env.S3_KEY }} \
            --timeout 60 \
            --memory-size 256 \
            --environment "Variables={FINNHUB_API_KEY=${FINNHUB_API_KEY}}" \
            --description "Test Lambda for Finnhub API integration"

          echo "âœ… Lambda function created successfully!"

      - name: Update Lambda function (if exists)
        if: steps.check_function.outputs.exists == 'true'
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ğŸš€ Updating Lambda function: TEST_FINNHUB_LAMBDA"
          echo "ğŸ“¦ Using S3 key: ${{ env.S3_KEY }}"

          # æ›´æ–°å‡½æ•°ä»£ç 
          aws lambda update-function-code \
            --function-name TEST_FINNHUB_LAMBDA \
            --s3-bucket damonxuda-projects \
            --s3-key ${{ env.S3_KEY }}

          # ç­‰å¾…å‡½æ•°æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TEST_FINNHUB_LAMBDA

          # æ›´æ–°ç¯å¢ƒå˜é‡
          echo "ğŸ”§ Updating environment variables..."
          aws lambda update-function-configuration \
            --function-name TEST_FINNHUB_LAMBDA \
            --environment "Variables={FINNHUB_API_KEY=${FINNHUB_API_KEY}}"

          # ç­‰å¾…é…ç½®æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name TEST_FINNHUB_LAMBDA

          echo "âœ… TEST_FINNHUB_LAMBDA updated successfully!"
