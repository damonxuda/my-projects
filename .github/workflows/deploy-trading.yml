name: Deploy Trading System

on:
  push:
    branches: [main]
    paths:
      - 'backend/lambda-trading-shared/**'
      - 'backend/lambda-cc-trading/**'
      - 'backend/lambda-stock-trading/**'
      - '.github/workflows/deploy-trading.yml'
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  deploy-trading-shared-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì¶ Installing dependencies for Lambda Layer..."
          npm install --production

          echo "‚úÖ Dependencies installed:"
          ls -la node_modules/ | head -20

      - name: Create Layer package
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì¶ Creating Lambda Layer package..."

          # ÂàõÂª∫ Layer ÁõÆÂΩïÁªìÊûÑÔºàÂøÖÈ°ªÊòØ nodejs/Ôºâ
          mkdir -p layer/nodejs

          # Â§çÂà∂Ê†∏ÂøÉ‰ª£Á†ÅÊñá‰ª∂
          echo "Copying core modules..."
          cp llm-clients.mjs layer/nodejs/
          cp technical-indicators.mjs layer/nodejs/
          cp decision-parser.mjs layer/nodejs/
          cp portfolio-management.mjs layer/nodejs/
          cp utils.mjs layer/nodejs/
          cp index.mjs layer/nodejs/

          # Â§çÂà∂ package.json
          cp package.json layer/nodejs/

          # Â§çÂà∂ node_modules
          echo "Copying node_modules..."
          cp -r node_modules layer/nodejs/

          # ÊâìÂåÖ Layer
          cd layer
          zip -r ../layer.zip nodejs/ -q
          cd ..

          echo "‚úÖ Layer package created:"
          ls -lh layer.zip
          echo "Package size: $(ls -lh layer.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish Lambda Layer
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì§ Publishing Lambda Layer to AWS..."

          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name lambda-trading-shared \
            --description "Shared modules for trading systems (LLM clients, indicators, decision parser, utils)" \
            --zip-file fileb://layer.zip \
            --compatible-runtimes nodejs20.x \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Version' \
            --output text)

          echo "‚úÖ Published lambda-trading-shared Layer version: ${LAYER_VERSION}"

          # ‰øùÂ≠ò Layer ARN Âà∞ÁéØÂ¢ÉÂèòÈáè
          LAYER_ARN="arn:aws:lambda:${{ secrets.AWS_REGION }}:730335478220:layer:lambda-trading-shared:${LAYER_VERSION}"
          echo "LAYER_ARN=${LAYER_ARN}" >> $GITHUB_ENV
          echo "LAYER_VERSION=${LAYER_VERSION}" >> $GITHUB_ENV

          echo "üìå Layer ARN: ${LAYER_ARN}"

      - name: Update TRADING_CC_LAMBDA to use new Layer
        run: |
          echo "üîó Updating TRADING_CC_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_CC_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "‚è≥ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "‚úÖ TRADING_CC_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Update TRADING_STOCK_LAMBDA to use new Layer
        run: |
          echo "üîó Updating TRADING_STOCK_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_STOCK_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "‚è≥ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "‚úÖ TRADING_STOCK_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Deployment Summary
        run: |
          echo "üéâ Lambda Layer Deployment Complete!"
          echo ""
          echo "üì¶ Layer Name: lambda-trading-shared"
          echo "üìå Layer ARN: ${LAYER_ARN}"
          echo "üî¢ Layer Version: ${LAYER_VERSION}"
          echo ""
          echo "‚úÖ Updated Functions:"
          echo "  - TRADING_CC_LAMBDA (Crypto Trading)"
          echo "  - TRADING_STOCK_LAMBDA (Stock Trading)"
          echo ""
          echo "üí° To update other functions manually, use:"
          echo "   aws lambda update-function-configuration \\"
          echo "     --function-name YOUR_FUNCTION_NAME \\"
          echo "     --layers \"${LAYER_ARN}\""
