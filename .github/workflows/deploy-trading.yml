name: Deploy Trading System

on:
  push:
    branches: [main]
    paths:
      - 'backend/lambda-trading-shared/**'
      - 'backend/lambda-cc-trading/**'
      - 'backend/lambda-stock-trading/**'
      - '.github/workflows/deploy-trading.yml'
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  deploy-trading-shared-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì¶ Installing dependencies for Lambda Layer..."
          npm install --production

          echo "‚úÖ Dependencies installed:"
          ls -la node_modules/ | head -20

      - name: Create Layer package
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì¶ Creating Lambda Layer package..."

          # ÂàõÂª∫ Layer ÁõÆÂΩïÁªìÊûÑÔºàÂøÖÈ°ªÊòØ nodejs/Ôºâ
          mkdir -p layer/nodejs

          # Â§çÂà∂Ê†∏ÂøÉ‰ª£Á†ÅÊñá‰ª∂
          echo "Copying core modules..."
          cp llm-clients.mjs layer/nodejs/
          cp technical-indicators.mjs layer/nodejs/
          cp decision-parser.mjs layer/nodejs/
          cp portfolio-management.mjs layer/nodejs/
          cp utils.mjs layer/nodejs/
          cp index.mjs layer/nodejs/

          # Â§çÂà∂ package.json
          cp package.json layer/nodejs/

          # Â§çÂà∂ node_modules
          echo "Copying node_modules..."
          cp -r node_modules layer/nodejs/

          # ÊâìÂåÖ Layer
          cd layer
          zip -r ../layer.zip nodejs/ -q
          cd ..

          echo "‚úÖ Layer package created:"
          ls -lh layer.zip
          echo "Package size: $(ls -lh layer.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish Lambda Layer
        working-directory: ./backend/lambda-trading-shared
        run: |
          echo "üì§ Publishing Lambda Layer to AWS..."

          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name lambda-trading-shared \
            --description "Shared modules for trading systems (LLM clients, indicators, decision parser, utils)" \
            --zip-file fileb://layer.zip \
            --compatible-runtimes nodejs20.x \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Version' \
            --output text)

          echo "‚úÖ Published lambda-trading-shared Layer version: ${LAYER_VERSION}"

          # ‰øùÂ≠ò Layer ARN Âà∞ÁéØÂ¢ÉÂèòÈáè
          LAYER_ARN="arn:aws:lambda:${{ secrets.AWS_REGION }}:730335478220:layer:lambda-trading-shared:${LAYER_VERSION}"
          echo "LAYER_ARN=${LAYER_ARN}" >> $GITHUB_ENV
          echo "LAYER_VERSION=${LAYER_VERSION}" >> $GITHUB_ENV

          echo "üìå Layer ARN: ${LAYER_ARN}"

      - name: Update TRADING_CC_LAMBDA to use new Layer
        run: |
          echo "üîó Updating TRADING_CC_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_CC_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "‚è≥ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "‚úÖ TRADING_CC_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Update TRADING_STOCK_LAMBDA to use new Layer
        run: |
          echo "üîó Updating TRADING_STOCK_LAMBDA to use Layer version ${LAYER_VERSION}..."

          aws lambda update-function-configuration \
            --function-name TRADING_STOCK_LAMBDA \
            --layers "${LAYER_ARN}" \
            --region ${{ secrets.AWS_REGION }}

          echo "‚è≥ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA \
            --region ${{ secrets.AWS_REGION }}

          echo "‚úÖ TRADING_STOCK_LAMBDA updated to Layer version ${LAYER_VERSION}"

      - name: Deployment Summary
        run: |
          echo "üéâ Lambda Layer Deployment Complete!"
          echo ""
          echo "üì¶ Layer Name: lambda-trading-shared"
          echo "üìå Layer ARN: ${LAYER_ARN}"
          echo "üî¢ Layer Version: ${LAYER_VERSION}"
          echo ""
          echo "‚úÖ Updated Functions:"
          echo "  - TRADING_CC_LAMBDA (Crypto Trading)"
          echo "  - TRADING_STOCK_LAMBDA (Stock Trading)"
          echo ""
          echo "üí° To update other functions manually, use:"
          echo "   aws lambda update-function-configuration \\"
          echo "     --function-name YOUR_FUNCTION_NAME \\"
          echo "     --layers \"${LAYER_ARN}\""

  deploy-trading-cc:
    runs-on: ubuntu-latest
    # Crypto trading lambda uses lambda-trading-shared Layer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package (code only, no node_modules)
        working-directory: ./backend/lambda-cc-trading
        run: |
          echo "üì¶ Creating TRADING_CC_LAMBDA package (Crypto Trading)..."
          echo "‚ö†Ô∏è  Using lambda-trading-shared Layer for dependencies"

          # Âè™ÊâìÂåÖ‰ª£Á†ÅÊñá‰ª∂
          zip -r function.zip index.mjs -x "*.DS_Store" "node_modules/*" "*.zip"

          ls -lh function.zip
          echo "‚úÖ Package size: $(ls -lh function.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        working-directory: ./backend/lambda-cc-trading
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_KEY="lambda-deploy/TRADING_CC_LAMBDA-${TIMESTAMP}.zip"

          echo "üì§ Uploading to S3: s3://damonxuda-video-files/${S3_KEY}"
          aws s3 cp function.zip s3://damonxuda-video-files/${S3_KEY}

          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Deploy to Lambda
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_PRO_API_KEY: ${{ secrets.GEMINI_PRO_API_KEY }}
          GEMINI_FLASH_API_KEY: ${{ secrets.GEMINI_FLASH_API_KEY }}
          CLAUDE_SONNET_API_KEY: ${{ secrets.CLAUDE_SONNET_API_KEY }}
          CLAUDE_HAIKU_API_KEY: ${{ secrets.CLAUDE_HAIKU_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Deploying TRADING_CC_LAMBDA (Crypto Trading)..."
          echo "üì¶ Using S3 key: ${{ env.S3_KEY }}"

          # Êõ¥Êñ∞ÂáΩÊï∞‰ª£Á†Å
          aws lambda update-function-code \
            --function-name TRADING_CC_LAMBDA \
            --s3-bucket damonxuda-video-files \
            --s3-key ${{ env.S3_KEY }}

          # Á≠âÂæÖÂáΩÊï∞Êõ¥Êñ∞ÂÆåÊàê
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA

          # Êõ¥Êñ∞ÁéØÂ¢ÉÂèòÈáèÔºàLambda Layer Áî± deploy-layer.yml ÁÆ°ÁêÜÔºâ
          echo "üîß Updating environment variables..."
          aws lambda update-function-configuration \
            --function-name TRADING_CC_LAMBDA \
            --environment "Variables={GEMINI_API_KEY=${GEMINI_API_KEY},GEMINI_PRO_API_KEY=${GEMINI_PRO_API_KEY},GEMINI_FLASH_API_KEY=${GEMINI_FLASH_API_KEY},CLAUDE_SONNET_API_KEY=${CLAUDE_SONNET_API_KEY},CLAUDE_HAIKU_API_KEY=${CLAUDE_HAIKU_API_KEY},DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY},GROK_API_KEY=${GROK_API_KEY},OPENAI_API_KEY=${OPENAI_API_KEY},CRYPTOCOMPARE_API_KEY=${CRYPTOCOMPARE_API_KEY},COINGECKO_API_KEY=${COINGECKO_API_KEY},SUPABASE_URL=${SUPABASE_URL},SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}}"

          # Á≠âÂæÖÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê
          aws lambda wait function-updated \
            --function-name TRADING_CC_LAMBDA

          echo "‚úÖ TRADING_CC_LAMBDA deployed successfully!"

  deploy-trading-stock:
    runs-on: ubuntu-latest
    # Stock trading lambda uses lambda-trading-shared Layer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package (code only, no node_modules)
        working-directory: ./backend/lambda-stock-trading
        run: |
          echo "üì¶ Creating TRADING_STOCK_LAMBDA package (Stock Trading)..."
          echo "‚ö†Ô∏è  Using lambda-trading-shared Layer for dependencies"

          # Âè™ÊâìÂåÖ‰ª£Á†ÅÊñá‰ª∂
          zip -r function.zip index.mjs -x "*.DS_Store" "node_modules/*" "*.zip"

          ls -lh function.zip
          echo "‚úÖ Package size: $(ls -lh function.zip | awk '{print $5}')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        working-directory: ./backend/lambda-stock-trading
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_KEY="lambda-deploy/TRADING_STOCK_LAMBDA-${TIMESTAMP}.zip"

          echo "üì§ Uploading to S3: s3://damonxuda-video-files/${S3_KEY}"
          aws s3 cp function.zip s3://damonxuda-video-files/${S3_KEY}

          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Deploy to Lambda
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_PRO_API_KEY: ${{ secrets.GEMINI_PRO_API_KEY }}
          GEMINI_FLASH_API_KEY: ${{ secrets.GEMINI_FLASH_API_KEY }}
          CLAUDE_SONNET_API_KEY: ${{ secrets.CLAUDE_SONNET_API_KEY }}
          CLAUDE_HAIKU_API_KEY: ${{ secrets.CLAUDE_HAIKU_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Deploying TRADING_STOCK_LAMBDA (Stock Trading)..."
          echo "üì¶ Using S3 key: ${{ env.S3_KEY }}"

          # Êõ¥Êñ∞ÂáΩÊï∞‰ª£Á†Å
          aws lambda update-function-code \
            --function-name TRADING_STOCK_LAMBDA \
            --s3-bucket damonxuda-video-files \
            --s3-key ${{ env.S3_KEY }}

          # Á≠âÂæÖÂáΩÊï∞Êõ¥Êñ∞ÂÆåÊàê
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA

          # Êõ¥Êñ∞ÁéØÂ¢ÉÂèòÈáèÔºàLambda Layer Áî± deploy-layer.yml ÁÆ°ÁêÜÔºâ
          echo "üîß Updating environment variables..."
          aws lambda update-function-configuration \
            --function-name TRADING_STOCK_LAMBDA \
            --environment "Variables={GEMINI_API_KEY=${GEMINI_API_KEY},GEMINI_PRO_API_KEY=${GEMINI_PRO_API_KEY},GEMINI_FLASH_API_KEY=${GEMINI_FLASH_API_KEY},CLAUDE_SONNET_API_KEY=${CLAUDE_SONNET_API_KEY},CLAUDE_HAIKU_API_KEY=${CLAUDE_HAIKU_API_KEY},DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY},GROK_API_KEY=${GROK_API_KEY},OPENAI_API_KEY=${OPENAI_API_KEY},ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY},SUPABASE_URL=${SUPABASE_URL},SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}}"

          # Á≠âÂæÖÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê
          aws lambda wait function-updated \
            --function-name TRADING_STOCK_LAMBDA

          echo "‚úÖ TRADING_STOCK_LAMBDA deployed successfully!"
