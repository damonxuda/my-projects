# .github/workflows/deploy-lambda.yml
name: Deploy Video Management Lambda Services

on:
  push:
    branches: [main]
    paths:
      - 'lambda-video-management/services/**'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      deploy_all:
        description: 'Deploy all services'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy-lambdas:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            lambda-video-management/services/video-core/package-lock.json
            lambda-video-management/services/video-processing/package-lock.json
            lambda-video-management/services/youtube/package-lock.json

      # 3. é…ç½® AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 4. æ£€æµ‹LambdaæœåŠ¡å˜åŒ–
      - name: Detect Lambda service changes
        id: lambda_changes
        working-directory: ./lambda-video-management
        run: |
          echo "ğŸ” æ£€æµ‹LambdaæœåŠ¡å˜åŒ–..."

          # æ£€æµ‹æ¯ä¸ªLambdaæœåŠ¡çš„å˜åŒ–
          for service in video-core video-processing youtube; do
            if git diff --name-only HEAD~1 HEAD | grep -q "lambda-video-management/services/${service}/"; then
              echo "${service//-/_}_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… ${service} service has changes"
            else
              echo "${service//-/_}_changed=false" >> $GITHUB_OUTPUT
              echo "â– ${service} service has no changes"
            fi
          done

          # æ£€æµ‹å…±äº«æ¨¡å—å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "lambda-video-management/services/shared/"; then
            echo "shared_changed=true" >> $GITHUB_OUTPUT
            echo "video_core_changed=true" >> $GITHUB_OUTPUT
            echo "video_processing_changed=true" >> $GITHUB_OUTPUT
            echo "youtube_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Shared modules changed, forcing all services rebuild"
          else
            echo "shared_changed=false" >> $GITHUB_OUTPUT
          fi

          # å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰æœåŠ¡
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" ]]; then
            echo "video_core_changed=true" >> $GITHUB_OUTPUT
            echo "video_processing_changed=true" >> $GITHUB_OUTPUT
            echo "youtube_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deploy all Lambda services"
          fi

      # 5. éƒ¨ç½² video-core-lambda
      - name: Deploy video-core-lambda
        if: steps.lambda_changes.outputs.video_core_changed == 'true'
        working-directory: ./lambda-video-management/services/video-core
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          ADMIN_EMAILS: "damon.xu@gmail.com"
          VIDEO_BUCKET_NAME: "damonxuda-video-files"
        run: |
          echo "ğŸš€ Deploying video-core-lambda..."
          npm ci
          chmod +x deploy.sh
          ./deploy.sh
          echo "âœ… video-core-lambda deployed successfully"

      # 6. éƒ¨ç½² video-processing-lambda
      - name: Deploy video-processing-lambda
        if: steps.lambda_changes.outputs.video_processing_changed == 'true'
        working-directory: ./lambda-video-management/services/video-processing
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          ADMIN_EMAILS: "damon.xu@gmail.com"
          VIDEO_BUCKET_NAME: "damonxuda-video-files"
          MEDIACONVERT_ROLE_ARN: ${{ secrets.MEDIACONVERT_ROLE_ARN }}
          MEDIACONVERT_QUEUE_ARN: ${{ secrets.MEDIACONVERT_QUEUE_ARN }}
        run: |
          echo "ğŸš€ Deploying video-processing-lambda..."
          npm ci
          chmod +x deploy.sh
          ./deploy.sh
          echo "âœ… video-processing-lambda deployed successfully"

      # 7. éƒ¨ç½² youtube-lambda (ç®€åŒ–ç‰ˆæœ¬)
      - name: Deploy youtube-lambda
        if: steps.lambda_changes.outputs.youtube_changed == 'true'
        working-directory: ./lambda-video-management/services/youtube
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          ADMIN_EMAILS: "damon.xu@gmail.com"
          VIDEO_BUCKET_NAME: "damonxuda-video-files"
        run: |
          echo "ğŸš€ Deploying youtube-lambda..."
          npm ci
          chmod +x deploy.sh
          ./deploy.sh
          echo "âœ… youtube-lambda deployed successfully"

      # 8. è·å–Lambdaå‡½æ•°URLs
      - name: Get Lambda Function URLs
        run: |
          echo "ğŸ“‹ Lambda Function URLs:"
          echo "=========================="

          # è·å–video-core URL
          VIDEO_CORE_URL=$(aws lambda get-function-url-config --function-name video-core-lambda --query 'FunctionUrl' --output text 2>/dev/null || echo "Not configured")
          echo "ğŸ¬ Video Core API: $VIDEO_CORE_URL"

          # è·å–video-processing URL
          VIDEO_PROCESSING_URL=$(aws lambda get-function-url-config --function-name video-processing-lambda --query 'FunctionUrl' --output text 2>/dev/null || echo "Not configured")
          echo "âš™ï¸ Video Processing API: $VIDEO_PROCESSING_URL"

          # è·å–youtube URL
          YOUTUBE_URL=$(aws lambda get-function-url-config --function-name youtube-lambda --query 'FunctionUrl' --output text 2>/dev/null || echo "Not configured")
          echo "ğŸ“º YouTube API: $YOUTUBE_URL"

          echo ""
          echo "ğŸ’¡ Next steps:"
          echo "1. Update frontend environment variables with these URLs"
          echo "2. Test the new Lambda functions"
          echo "3. Update API calls in the frontend React app"

      # 9. éƒ¨ç½²æˆåŠŸæŠ¥å‘Š
      - name: Lambda Deploy Success Report
        run: |
          echo "ğŸ‰ LambdaæœåŠ¡éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ‘˜è¦:"
          echo "   Video Core: ${{ steps.lambda_changes.outputs.video_core_changed }}"
          echo "   Video Processing: ${{ steps.lambda_changes.outputs.video_processing_changed }}"
          echo "   YouTube: ${{ steps.lambda_changes.outputs.youtube_changed }}"
          echo "   Shared modules: ${{ steps.lambda_changes.outputs.shared_changed }}"
          echo ""
          echo "âœ… æ‰€æœ‰LambdaæœåŠ¡éƒ¨ç½²å®Œæˆï¼"