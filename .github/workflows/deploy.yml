name: Deploy Multi-Project to AWS S3

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–å‰ä¸¤ä¸ªcommitç”¨äºå˜åŒ–æ£€æµ‹

      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆReacté¡¹ç›®éœ€è¦ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "quiz/package-lock.json"

      # 3. é…ç½® AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 4. æ£€æµ‹é¡¹ç›®å˜åŒ–
      - name: Detect changed projects
        id: changes
        run: |
          echo "Detecting changes in projects..."

          # æ£€æµ‹ schedule é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^schedule/"; then
            echo "schedule_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Schedule project has changes"
          else
            echo "schedule_changed=false" >> $GITHUB_OUTPUT
            echo "â– Schedule project has no changes"
          fi

          # æ£€æµ‹ auth é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^auth/"; then
            echo "auth_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Auth project has changes"
          else
            echo "auth_changed=false" >> $GITHUB_OUTPUT
            echo "â– Auth project has no changes"
          fi

          # æ£€æµ‹ quiz é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^quiz/"; then
            echo "quiz_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Quiz project has changes"
          else
            echo "quiz_changed=false" >> $GITHUB_OUTPUT
            echo "â– Quiz project has no changes"
          fi

          # å¦‚æœauthå˜åŒ–ï¼Œquizä¹Ÿéœ€è¦é‡æ–°æ„å»ºï¼ˆå› ä¸ºquizä¾èµ–authï¼‰
          if [[ "$(cat $GITHUB_OUTPUT | grep auth_changed=true)" ]]; then
            echo "quiz_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Auth changed, forcing Quiz rebuild"
          fi

          # æ£€æµ‹æ˜¯å¦æ˜¯é¦–æ¬¡éƒ¨ç½²æˆ–å¼ºåˆ¶éƒ¨ç½²
          if [[ "${{ github.event.forced }}" == "true" ]] || [[ $(git rev-list --count HEAD) -le 1 ]] || [[ ! $(git diff --name-only HEAD~1 HEAD) ]]; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deploy mode - will deploy all projects"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi

      # 5. éƒ¨ç½² Schedule é¡¹ç›®ï¼ˆé™æ€æ–‡ä»¶ï¼‰
      - name: Deploy Schedule
        if: steps.changes.outputs.schedule_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Deploying Schedule to /schedule path..."

          # åŒæ­¥ä¸Šä¼  schedule é¡¹ç›®åˆ° S3 çš„ schedule è·¯å¾„
          aws s3 sync ./schedule/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ \
            --delete \
            --exclude ".DS_Store" \
            --exclude "*.md" \
            --exclude "README*" \
            --exclude "LICENSE*" \
            --exclude ".env*" \
            --exclude "*.zip" \
            --exclude "*.tar" \
            --exclude "*.gz" \
            --exclude "package*.json" \
            --exclude "tsconfig.json" \
            --exclude "webpack.config.js" \
            --exclude "gulpfile.js" \
            --exclude "Gruntfile.js" \
            --exclude ".gitignore" \
            --exclude ".gitattributes" \
            --exclude ".editorconfig" \
            --exclude ".eslintrc*" \
            --exclude ".prettierrc*" \
            --exclude "*.log"

          echo "âœ… Schedule deployed to /schedule path"

      # 6. æ„å»ºå¹¶éƒ¨ç½² Quiz é¡¹ç›®ï¼ˆReactåº”ç”¨ï¼‰
      - name: Build and Deploy Quiz
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Building and deploying Quiz Management to /quiz path..."

          # æ£€æŸ¥ quiz ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "./quiz" ]; then
            echo "âœ… Quiz directory found, starting build process..."
            echo "âœ… Quiz Management built and deployed to /quiz path"
          else
            echo "âš ï¸  Quiz directory not found, skipping deployment"
          fi

      # 6a. Install Quiz Dependencies
      - name: Install Quiz Dependencies
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./quiz
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci

      # 6b. Build Quiz Application
      - name: Build Quiz Application
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./quiz
        run: |
          echo "ğŸ”§ Setting environment variables..."
          echo "REACT_APP_SUPABASE_URL=${{ secrets.REACT_APP_SUPABASE_URL }}" >> .env.production
          echo "REACT_APP_SUPABASE_ANON_KEY=${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}" >> .env.production
          echo "GENERATE_SOURCEMAP=false" >> .env.production

          echo "ğŸ—ï¸ Building React application..."
          npm run build

      # 6c. Deploy Quiz to S3
      - name: Deploy Quiz to S3
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "â˜ï¸ Uploading to S3..."
          aws s3 sync ./quiz/build/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ \
            --delete \
            --exclude ".DS_Store"
          echo "âœ… Quiz Management deployed to /quiz path"

      # 7. éƒ¨ç½²æ ¹ç›®å½•æ–‡ä»¶
      - name: Deploy root files
        run: |
          echo "ğŸš€ Deploying root directory files..."

          # ä¸Šä¼ æ ¹ç›®å½•çš„ index.htmlï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "./index.html" ]; then
            aws s3 cp ./index.html s3://${{ secrets.AWS_S3_BUCKET_NAME }}/index.html
            echo "âœ… Root index.html deployed"
          else
            echo "â„¹ï¸  No root index.html found"
          fi

      # 8. éªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify deployments
        run: |
          echo "ğŸ“ Verifying deployed projects..."

          # æ£€æŸ¥æ ¹ç›®å½• index.html
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/index.html >/dev/null 2>&1; then
            echo "âœ… Root index.html found in S3"
          else
            echo "âŒ Root index.html not found in S3"
          fi

          # æ£€æŸ¥ schedule éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ >/dev/null 2>&1; then
            echo "âœ… Schedule files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ --recursive | head -5
          else
            echo "âŒ Schedule files not found in S3"
          fi

          # æ£€æŸ¥ quiz éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ >/dev/null 2>&1; then
            echo "âœ… Quiz Management files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ --recursive | head -5
          else
            echo "â„¹ï¸  Quiz Management files not found in S3 (may not be created yet)"
          fi

      # 9. æ¸…ç†ç¼“å­˜ï¼ˆå¦‚æœä½¿ç”¨ CloudFrontï¼‰
      - name: Invalidate CloudFront cache (optional)
        continue-on-error: true
        run: |
          echo "CloudFront invalidation step (currently disabled)"
          echo "To enable: uncomment and set CLOUDFRONT_DISTRIBUTION_ID secret"
          # å¦‚æœå¯ç”¨ CloudFrontï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç 
          # PATHS_TO_INVALIDATE=""
          # if [[ "${{ steps.changes.outputs.schedule_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /schedule/*"
          # fi
          # if [[ "${{ steps.changes.outputs.quiz_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /quiz/*"
          # fi
          # if [[ -n "$PATHS_TO_INVALIDATE" ]]; then
          #   aws cloudfront create-invalidation \
          #     --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          #     --paths $PATHS_TO_INVALIDATE
          # fi

      # 10. éƒ¨ç½²æˆåŠŸæŠ¥å‘Š
      - name: Deploy Success Report
        run: |
          echo "ğŸ‰ å¤šé¡¹ç›®éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ‘˜è¦:"
          echo "   Schedule å˜åŒ–: ${{ steps.changes.outputs.schedule_changed }}"
          echo "   Auth å˜åŒ–: ${{ steps.changes.outputs.auth_changed }}"
          echo "   Quiz å˜åŒ–: ${{ steps.changes.outputs.quiz_changed }}"
          echo "   å¼ºåˆ¶éƒ¨ç½²æ¨¡å¼: ${{ steps.changes.outputs.force_deploy }}"
          echo ""
          echo "ğŸŒ é¡¹ç›®è®¿é—®åœ°å€:"
          echo "   ğŸ“š Schedule: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/schedule/"
          echo "   ğŸ§  Quiz Management: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/quiz/"
          echo ""
          echo "âœ… åŠŸèƒ½ç‰¹æ€§:"
          echo "   - æ™ºèƒ½å˜åŒ–æ£€æµ‹ï¼šåªéƒ¨ç½²æœ‰å˜åŒ–çš„é¡¹ç›®"
          echo "   - React æ„å»ºï¼šè‡ªåŠ¨æ„å»ºquizé¡¹ç›®"
          echo "   - è·¯å¾„åˆ†ç¦»ï¼šæ¯ä¸ªé¡¹ç›®ç‹¬ç«‹çš„è®¿é—®è·¯å¾„"
          echo "   - ä¾èµ–æ£€æµ‹ï¼šauthå˜åŒ–æ—¶è‡ªåŠ¨é‡å»ºquiz"
          echo ""
          echo "ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®:"
          echo "   1. åˆ›å»º Supabase é¡¹ç›®å¹¶é…ç½® GitHub Secrets"
          echo "   2. æµ‹è¯•ä¸¤ä¸ªé¡¹ç›®çš„ç‹¬ç«‹è®¿é—®"
          echo "   3. è€ƒè™‘é…ç½®è‡ªå®šä¹‰åŸŸåå’Œ HTTPS"
