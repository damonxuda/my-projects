name: Deploy Multi-Project to AWS S3

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–å‰ä¸¤ä¸ªcommitç”¨äºå˜åŒ–æ£€æµ‹

      # 2. é…ç½® AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. æ£€æµ‹é¡¹ç›®å˜åŒ–
      - name: Detect changed projects
        id: changes
        run: |
          echo "Detecting changes in projects..."

          # æ£€æµ‹ course-schedule é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^course-schedule/"; then
            echo "course_schedule_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Course Schedule project has changes"
          else
            echo "course_schedule_changed=false" >> $GITHUB_OUTPUT
            echo "â– Course Schedule project has no changes"
          fi

          # æ£€æµ‹ quiz-management é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^quiz-management/"; then
            echo "quiz_management_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Quiz Management project has changes"
          else
            echo "quiz_management_changed=false" >> $GITHUB_OUTPUT
            echo "â– Quiz Management project has no changes"
          fi

          # æ£€æµ‹æ˜¯å¦æ˜¯é¦–æ¬¡éƒ¨ç½²æˆ–å¼ºåˆ¶éƒ¨ç½²
          if [[ "${{ github.event.forced }}" == "true" ]] || [[ $(git rev-list --count HEAD) -le 1 ]]; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deploy mode - will deploy all projects"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi

      # 4. éƒ¨ç½² Course Schedule é¡¹ç›®
      - name: Deploy Course Schedule
        if: steps.changes.outputs.course_schedule_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Deploying Course Schedule to /course-schedule path..."

          # åŒæ­¥ä¸Šä¼  course-schedule é¡¹ç›®åˆ° S3 çš„ course-schedule è·¯å¾„
          aws s3 sync ./course-schedule/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/course-schedule/ \
            --delete \
            --exclude ".DS_Store" \
            --exclude "*.md" \
            --exclude "README*" \
            --exclude "LICENSE*" \
            --exclude ".env*" \
            --exclude "*.zip" \
            --exclude "*.tar" \
            --exclude "*.gz" \
            --exclude "package*.json" \
            --exclude "tsconfig.json" \
            --exclude "webpack.config.js" \
            --exclude "gulpfile.js" \
            --exclude "Gruntfile.js" \
            --exclude ".gitignore" \
            --exclude ".gitattributes" \
            --exclude ".editorconfig" \
            --exclude ".eslintrc*" \
            --exclude ".prettierrc*" \
            --exclude "*.log"

          echo "âœ… Course Schedule deployed to /course-schedule path"

      # 5. éƒ¨ç½² Quiz Management é¡¹ç›®
      - name: Deploy Quiz Management
        if: steps.changes.outputs.quiz_management_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Deploying Quiz Management to /quiz path..."

          # æ£€æŸ¥ quiz-management ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "./quiz-management" ]; then
            # åŒæ­¥ä¸Šä¼  quiz-management é¡¹ç›®åˆ° S3 çš„ quiz è·¯å¾„
            aws s3 sync ./quiz-management/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ \
              --delete \
              --exclude ".DS_Store" \
              --exclude "*.md" \
              --exclude "README*" \
              --exclude "LICENSE*" \
              --exclude ".env*" \
              --exclude "*.zip" \
              --exclude "*.tar" \
              --exclude "*.gz" \
              --exclude "package*.json" \
              --exclude "tsconfig.json" \
              --exclude "webpack.config.js" \
              --exclude "gulpfile.js" \
              --exclude "Gruntfile.js" \
              --exclude ".gitignore" \
              --exclude ".gitattributes" \
              --exclude ".editorconfig" \
              --exclude ".eslintrc*" \
              --exclude ".prettierrc*" \
              --exclude "*.log"
            
            echo "âœ… Quiz Management deployed to /quiz path"
          else
            echo "âš ï¸  Quiz Management directory not found, skipping deployment"
          fi

      # 6. éªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify deployments
        run: |
          echo "ğŸ“ Verifying deployed projects..."

          # æ£€æŸ¥ course-schedule éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/course-schedule/ >/dev/null 2>&1; then
            echo "âœ… Course Schedule files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/course-schedule/ --recursive | head -5
          else
            echo "âŒ Course Schedule files not found in S3"
          fi

          # æ£€æŸ¥ quiz-management éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ >/dev/null 2>&1; then
            echo "âœ… Quiz Management files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ --recursive | head -5
          else
            echo "â„¹ï¸  Quiz Management files not found in S3 (may not be created yet)"
          fi

      # 7. æ¸…ç†ç¼“å­˜ï¼ˆå¦‚æœä½¿ç”¨ CloudFrontï¼‰
      - name: Invalidate CloudFront cache (optional)
        continue-on-error: true
        run: |
          echo "CloudFront invalidation step (currently disabled)"
          echo "To enable: uncomment and set CLOUDFRONT_DISTRIBUTION_ID secret"
          # å¦‚æœå¯ç”¨ CloudFrontï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç 
          # PATHS_TO_INVALIDATE=""
          # if [[ "${{ steps.changes.outputs.course_schedule_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /course-schedule/*"
          # fi
          # if [[ "${{ steps.changes.outputs.quiz_management_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /quiz/*"
          # fi
          # if [[ -n "$PATHS_TO_INVALIDATE" ]]; then
          #   aws cloudfront create-invalidation \
          #     --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          #     --paths $PATHS_TO_INVALIDATE
          # fi

      # 8. éƒ¨ç½²æˆåŠŸæŠ¥å‘Š
      - name: Deploy Success Report
        run: |
          echo "ğŸ‰ å¤šé¡¹ç›®éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ‘˜è¦:"
          echo "   Course Schedule å˜åŒ–: ${{ steps.changes.outputs.course_schedule_changed }}"
          echo "   Quiz Management å˜åŒ–: ${{ steps.changes.outputs.quiz_management_changed }}"
          echo "   å¼ºåˆ¶éƒ¨ç½²æ¨¡å¼: ${{ steps.changes.outputs.force_deploy }}"
          echo ""
          echo "ğŸŒ é¡¹ç›®è®¿é—®åœ°å€:"
          echo "   ğŸ“š Course Schedule: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/course-schedule/"
          echo "   ğŸ§  Quiz Management: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/quiz/"
          echo ""
          echo "âœ… åŠŸèƒ½ç‰¹æ€§:"
          echo "   - æ™ºèƒ½å˜åŒ–æ£€æµ‹ï¼šåªéƒ¨ç½²æœ‰å˜åŒ–çš„é¡¹ç›®"
          echo "   - è·¯å¾„åˆ†ç¦»ï¼šæ¯ä¸ªé¡¹ç›®ç‹¬ç«‹çš„è®¿é—®è·¯å¾„"
          echo "   - å†å²ä¿ç•™ï¼šä¿æŒåŸæœ‰ Git å†å²å®Œæ•´æ€§"
          echo "   - æ‰©å±•æ€§ï¼šè½»æ¾æ·»åŠ æ›´å¤šé¡¹ç›®"
          echo ""
          echo "ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®:"
          echo "   1. åˆ›å»º quiz-management é¡¹ç›®ç›®å½•å’Œæ–‡ä»¶"
          echo "   2. æµ‹è¯•ä¸¤ä¸ªé¡¹ç›®çš„ç‹¬ç«‹è®¿é—®"
          echo "   3. è€ƒè™‘é…ç½®è‡ªå®šä¹‰åŸŸåå’Œ HTTPS"
          echo "   4. åç»­å¯æ·»åŠ æ›´å¤šé¡¹ç›®åˆ°åŒä¸€ä»“åº“"
