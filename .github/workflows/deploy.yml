name: Deploy to AWS S3

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. é…ç½® AWS CLI
    - name: Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    # 3. ä¸Šä¼ æ‰€æœ‰é™æ€æ–‡ä»¶å¹¶è®¾ç½®å…¬æœ‰è¯»æƒé™
    - name: Upload all static files with public-read permissions
      run: |
        echo "Uploading all static files with public-read permissions..."
        
        # åŒæ­¥ä¸Šä¼ æ‰€æœ‰é™æ€ç½‘ç«™æ–‡ä»¶ï¼Œè®¾ç½®å…¬æœ‰è¯»æƒé™ï¼Œå¹¶æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        aws s3 sync ./ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/ \
          --acl public-read \
          --delete \
          --exclude ".git/*" \
          --exclude ".github/*" \
          --exclude "node_modules/*" \
          --exclude ".DS_Store" \
          --exclude "*.md" \
          --exclude "README*" \
          --exclude "LICENSE*" \
          --exclude "*.yml" \
          --exclude "*.yaml" \
          --exclude ".env*" \
          --exclude "*.zip" \
          --exclude "*.tar" \
          --exclude "*.gz" \
          --exclude "package*.json" \
          --exclude "tsconfig.json" \
          --exclude "webpack.config.js" \
          --exclude "gulpfile.js" \
          --exclude "Gruntfile.js" \
          --exclude ".gitignore" \
          --exclude ".gitattributes" \
          --exclude ".editorconfig" \
          --exclude ".eslintrc*" \
          --exclude ".prettierrc*" \
          --exclude "*.log"
        
        echo "âœ… All static files uploaded with public-read permissions"
        echo "ğŸ“ Supported file types: HTML, CSS, JS, PNG, JPG, GIF, SVG, WOFF, TTF, JSON, XML, PDF, etc."
    
    # 4. AWS S3 ä¼šè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ Content-Typeï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
    - name: Verify content types (AWS S3 handles this automatically)
      run: |
        echo "âœ… AWS S3 static website hosting automatically handles Content-Type"
        echo "   - HTML files: text/html"
        echo "   - CSS files: text/css" 
        echo "   - JS files: application/javascript"
        echo "   - Images: image/jpeg, image/png, etc."
    
    # 5. éªŒè¯ä¸Šä¼ ç»“æœ
    - name: Verify upload and timestamps
      run: |
        echo "Verifying uploaded files and timestamps..."
        aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }}/ --recursive
        
        echo "Checking specific files info..."
        aws s3api head-object --bucket ${{ secrets.S3_BUCKET_NAME }} --key index.html || echo "Could not get index.html info"
        aws s3api head-object --bucket ${{ secrets.S3_BUCKET_NAME }} --key css/styles.css || echo "Could not get styles.css info" 
        aws s3api head-object --bucket ${{ secrets.S3_BUCKET_NAME }} --key js/app.js || echo "Could not get app.js info"
        aws s3api head-object --bucket ${{ secrets.S3_BUCKET_NAME }} --key js/config.js || echo "Could not get config.js info"
        
        echo "Upload verification completed"
    
    # 6. æ¸…ç†ç¼“å­˜ï¼ˆå¦‚æœä»¥åä½¿ç”¨ CloudFrontï¼‰
    - name: Invalidate CloudFront cache (optional, for future use)
      continue-on-error: true
      run: |
        echo "CloudFront invalidation step (currently disabled)"
        echo "To enable: uncomment and set CLOUDFRONT_DISTRIBUTION_ID secret"
        # aws cloudfront create-invalidation \
        #   --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
        #   --paths "/*"
    
    # 7. éƒ¨ç½²æˆåŠŸ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo ""
        echo "ğŸ“ ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
        aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/ --recursive | head -20
        echo ""
        echo "ğŸŒ ç½‘ç«™è®¿é—®åœ°å€:"
        echo "   âœ… S3 é™æ€ç½‘ç«™ç«¯ç‚¹: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com"
        echo "   ğŸ“± ç§»åŠ¨ç«¯å‹å¥½: å“åº”å¼è®¾è®¡å·²å¯ç”¨"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²åŒæ­¥å¹¶è®¾ç½®ä¸ºå…¬æœ‰è¯»æƒé™"
        echo "âœ… AWS S3 è‡ªåŠ¨å¤„ç† Content-Typeï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®"
        echo "âœ… ä½¿ç”¨åŒæ­¥æ¨¡å¼ï¼Œåªä¸Šä¼ å˜åŒ–çš„æ–‡ä»¶"
        echo ""
        echo "ğŸ“ å·²æ’é™¤çš„æ–‡ä»¶ç±»å‹ï¼š"
        echo "   - å¼€å‘å·¥å…·é…ç½®æ–‡ä»¶ (.gitignore, package.json, etc.)"
        echo "   - æºç ç®¡ç†æ–‡ä»¶ (.git, .github)"
        echo "   - ä¸´æ—¶æ–‡ä»¶ (.DS_Store, *.log, node_modules)"
        echo ""
        echo "âš ï¸  ä¸‹ä¸€æ­¥å»ºè®®ï¼š"
        echo "   1. é…ç½®è‡ªå®šä¹‰åŸŸåæŒ‡å‘ S3 ç«¯ç‚¹"
        echo "   2. è€ƒè™‘æ·»åŠ  CloudFront CDN ä»¥å¯ç”¨ HTTPS"
        echo "   3. è®¾ç½®åŸŸå DNS CNAME è®°å½•"
