name: Deploy Multi-Project to AWS S3

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–å‰ä¸¤ä¸ªcommitç”¨äºå˜åŒ–æ£€æµ‹

      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆReacté¡¹ç›®éœ€è¦ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "quiz/package-lock.json"

      # 3. é…ç½® AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 4. æ£€æµ‹é¡¹ç›®å˜åŒ–
      - name: Detect changed projects
        id: changes
        run: |
          echo "Detecting changes in projects..."

          # æ£€æµ‹ schedule é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^schedule/"; then
            echo "schedule_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Schedule project has changes"
          else
            echo "schedule_changed=false" >> $GITHUB_OUTPUT
            echo "â– Schedule project has no changes"
          fi

          # æ£€æµ‹ auth-clerk é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^auth-clerk/"; then
            echo "auth_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Auth-clerk project has changes"
          else
            echo "auth_changed=false" >> $GITHUB_OUTPUT
            echo "â– Auth-clerk project has no changes"
          fi

          # æ£€æµ‹ shared é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^shared/"; then
            echo "shared_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Shared project has changes"
          else
            echo "shared_changed=false" >> $GITHUB_OUTPUT
            echo "â– Shared project has no changes"
          fi

          # æ£€æµ‹ quiz é¡¹ç›®å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -q "^quiz/"; then
            echo "quiz_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Quiz project has changes"
          else
            echo "quiz_changed=false" >> $GITHUB_OUTPUT
            echo "â– Quiz project has no changes"
          fi

          # å¦‚æœauth-clerkæˆ–sharedå˜åŒ–ï¼Œquizä¹Ÿéœ€è¦é‡æ–°æ„å»ºï¼ˆå› ä¸ºquizä¾èµ–å®ƒä»¬ï¼‰
          if [[ "$(cat $GITHUB_OUTPUT | grep -E 'auth_changed=true|shared_changed=true')" ]]; then
            echo "quiz_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Auth-clerk or Shared changed, forcing Quiz rebuild"
          fi

          # æ£€æµ‹æ˜¯å¦æ˜¯é¦–æ¬¡éƒ¨ç½²æˆ–å¼ºåˆ¶éƒ¨ç½²
          if [[ "${{ github.event.forced }}" == "true" ]] || [[ $(git rev-list --count HEAD) -le 1 ]] || [[ ! $(git diff --name-only HEAD~1 HEAD) ]]; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deploy mode - will deploy all projects"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi

      # 5. éƒ¨ç½² Schedule é¡¹ç›®ï¼ˆé™æ€æ–‡ä»¶ï¼‰
      - name: Deploy Schedule
        if: steps.changes.outputs.schedule_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Deploying Schedule to /schedule path..."

          # åŒæ­¥ä¸Šä¼  schedule é¡¹ç›®åˆ° S3 çš„ schedule è·¯å¾„
          aws s3 sync ./schedule/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ \
            --delete \
            --exclude "*.md" \
            --exclude "README*" \
            --exclude "LICENSE*" \
            --exclude "package*.json" \
            --exclude "*.config.js" \
            --exclude "*.config.json" \
            --exclude ".gitignore" \
            --exclude ".eslintrc*" \
            --exclude ".prettierrc*"

          echo "âœ… Schedule deployed to /schedule path"

      # 6. æ„å»ºå¹¶éƒ¨ç½² Quiz é¡¹ç›®ï¼ˆReactåº”ç”¨ï¼‰
      - name: Build and Deploy Quiz
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸš€ Building and deploying Quiz Management to /quiz path..."

          # æ£€æŸ¥ quiz ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "./quiz" ]; then
            echo "âœ… Quiz directory found, starting build process..."
            echo "âœ… Quiz Management built and deployed to /quiz path"
          else
            echo "âš ï¸  Quiz directory not found, skipping deployment"
          fi

      # 6a. Install Quiz Dependencies
      - name: Install Quiz Dependencies
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./quiz
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci

          echo "ğŸ“¦ Installing shared dependencies..."
          cd ../shared && npm ci

          echo "ğŸ“¦ Installing auth-clerk dependencies..."
          cd ../auth-clerk && npm ci

      # 6b. Build Quiz Application
      - name: Build Quiz Application
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./quiz
        run: |
          echo "ğŸ”§ Setting environment variables..."
          echo "REACT_APP_SUPABASE_URL=${{ secrets.REACT_APP_SUPABASE_URL }}" >> .env.production
          echo "REACT_APP_SUPABASE_ANON_KEY=${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}" >> .env.production
          echo "REACT_APP_CLERK_PUBLISHABLE_KEY=${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}" >> .env.production
          echo "REACT_APP_ADMIN_EMAILS=${{ secrets.REACT_APP_ADMIN_EMAILS }}" >> .env.production
          echo "GENERATE_SOURCEMAP=false" >> .env.production

          echo "ğŸ—ï¸ Building React application..."
          npm run build

      # 6c. Deploy Quiz to S3
      - name: Deploy Quiz to S3
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "â˜ï¸ Force clearing S3 bucket and uploading fresh files..."
          # å…ˆå®Œå…¨åˆ é™¤æ•´ä¸ª quiz ç›®å½•
          aws s3 rm s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ --recursive
          echo "ğŸ—‘ï¸ Cleared existing quiz files"
          # ç„¶åé‡æ–°ä¸Šä¼ ï¼Œè®¾ç½®å¼ºåˆ¶ä¸ç¼“å­˜çš„å¤´éƒ¨
          aws s3 sync ./quiz/build/ s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --exclude ".DS_Store"
          echo "âœ… Quiz Management forcefully deployed with no-cache headers"

      # 7. éªŒè¯éƒ¨ç½²å’ŒClerkè®¤è¯
      - name: Verify Clerk Authentication Setup
        run: |
          echo "ğŸ” === Clerkè®¤è¯ç³»ç»ŸéªŒè¯ ==="
          echo ""
          echo "ğŸ” 1. æ£€æŸ¥ S3 ä¸Šçš„ quiz æ–‡ä»¶:"
          aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ --recursive --summarize
          echo ""
          echo "ğŸ” 2. æ£€æŸ¥ JS æ–‡ä»¶ç›®å½•:"
          aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/static/js/
          echo ""
          echo "ğŸ” 3. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®:"
          # è·å–ä¸»è¦çš„ JS æ–‡ä»¶å
          MAIN_JS=$(aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/static/js/ | grep main | awk '{print $4}' | head -1)
          if [ ! -z "$MAIN_JS" ]; then
            echo "æ‰¾åˆ°ä¸»è¦ JS æ–‡ä»¶: $MAIN_JS"
            echo "ä¸‹è½½å¹¶æ£€æŸ¥Clerké›†æˆ..."
            aws s3 cp s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/static/js/$MAIN_JS temp_main.js
            echo ""
            echo "ğŸ” 4. æ£€æŸ¥Clerkç»„ä»¶é›†æˆ:"
            if grep -q "ClerkAuthProvider\|SignedIn\|SignedOut" temp_main.js; then
              echo "âœ… æ‰¾åˆ°Clerkè®¤è¯ç»„ä»¶ï¼"
            else
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°Clerkè®¤è¯ç»„ä»¶"
            fi
            echo ""
            echo "ğŸ” 5. æ£€æŸ¥æ˜¯å¦ç§»é™¤äº†æ—§çš„Supabaseè®¤è¯:"
            if grep -q "AuthProvider.*supabase\|useAuth.*auth-legacy" temp_main.js; then
              echo "âš ï¸ ä»ç„¶åŒ…å«æ—§çš„Supabaseè®¤è¯ä»£ç "
            else
              echo "âœ… å·²æˆåŠŸç§»é™¤æ—§çš„è®¤è¯ä»£ç "
            fi
            echo ""
            echo "ğŸ” 6. æ£€æŸ¥ç®¡ç†å‘˜é‚®ç®±é…ç½®:"
            if grep -q "REACT_APP_ADMIN_EMAILS" temp_main.js; then
              echo "âœ… æ‰¾åˆ°ç®¡ç†å‘˜é‚®ç®±é…ç½®"
            else
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°ç®¡ç†å‘˜é‚®ç®±é…ç½®"
            fi
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä¸»è¦çš„ JS æ–‡ä»¶"
          fi
          echo ""
          echo "ğŸ“Š === Clerkè®¤è¯éªŒè¯æ€»ç»“ ==="

      # 8. éƒ¨ç½²æ ¹ç›®å½•æ–‡ä»¶
      - name: Deploy root files
        run: |
          echo "ğŸš€ Deploying root directory files..."

          # ä¸Šä¼ æ ¹ç›®å½•çš„ index.htmlï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "./index.html" ]; then
            aws s3 cp ./index.html s3://${{ secrets.AWS_S3_BUCKET_NAME }}/index.html
            echo "âœ… Root index.html deployed"
          else
            echo "â„¹ï¸  No root index.html found"
          fi

      # 9. éªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify deployments
        run: |
          echo "ğŸ“ Verifying deployed projects..."

          # æ£€æŸ¥æ ¹ç›®å½• index.html
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/index.html >/dev/null 2>&1; then
            echo "âœ… Root index.html found in S3"
          else
            echo "âŒ Root index.html not found in S3"
          fi

          # æ£€æŸ¥ schedule éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ >/dev/null 2>&1; then
            echo "âœ… Schedule files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/schedule/ --recursive | head -5
          else
            echo "âŒ Schedule files not found in S3"
          fi

          # æ£€æŸ¥ quiz éƒ¨ç½²
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ >/dev/null 2>&1; then
            echo "âœ… Quiz Management files found in S3"
            aws s3 ls s3://${{ secrets.AWS_S3_BUCKET_NAME }}/quiz/ --recursive | head -5
          else
            echo "â„¹ï¸  Quiz Management files not found in S3 (may not be created yet)"
          fi

      # 10. æ¸…ç†ç¼“å­˜ï¼ˆå¦‚æœä½¿ç”¨ CloudFrontï¼‰
      - name: Invalidate CloudFront cache (optional)
        continue-on-error: true
        run: |
          echo "CloudFront invalidation step (currently disabled)"
          echo "To enable: uncomment and set CLOUDFRONT_DISTRIBUTION_ID secret"
          # å¦‚æœå¯ç”¨ CloudFrontï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç 
          # PATHS_TO_INVALIDATE=""
          # if [[ "${{ steps.changes.outputs.schedule_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /schedule/*"
          # fi
          # if [[ "${{ steps.changes.outputs.quiz_changed }}" == "true" ]]; then
          #   PATHS_TO_INVALIDATE="${PATHS_TO_INVALIDATE} /quiz/*"
          # fi
          # if [[ -n "$PATHS_TO_INVALIDATE" ]]; then
          #   aws cloudfront create-invalidation \
          #     --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          #     --paths $PATHS_TO_INVALIDATE
          # fi

      # 11. éƒ¨ç½²æˆåŠŸæŠ¥å‘Š
      - name: Deploy Success Report
        run: |
          echo "ğŸ‰ å¤šé¡¹ç›®éƒ¨ç½²å®Œæˆ - Clerkè®¤è¯ç³»ç»Ÿå·²å¯ç”¨!"
          echo ""
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ‘˜è¦:"
          echo "   Schedule å˜åŒ–: ${{ steps.changes.outputs.schedule_changed }}"
          echo "   Auth-clerk å˜åŒ–: ${{ steps.changes.outputs.auth_changed }}"
          echo "   Shared å˜åŒ–: ${{ steps.changes.outputs.shared_changed }}"
          echo "   Quiz å˜åŒ–: ${{ steps.changes.outputs.quiz_changed }}"
          echo "   å¼ºåˆ¶éƒ¨ç½²æ¨¡å¼: ${{ steps.changes.outputs.force_deploy }}"
          echo ""
          echo "ğŸ” è®¤è¯ç³»ç»Ÿ:"
          echo "   è®¤è¯æœåŠ¡: Clerk (æ›¿ä»£Supabaseè®¤è¯)"
          echo "   ç”¨æˆ·ç®¡ç†: åŒé‡éªŒè¯ (Clerk + ç®¡ç†å‘˜å®¡æ‰¹)"
          echo "   çŸ¥è¯†äº§æƒä¿æŠ¤: å¯ç”¨å®¡æ‰¹åˆ¶è®¿é—®æ§åˆ¶"
          echo ""
          echo "ğŸŒ é¡¹ç›®è®¿é—®åœ°å€:"
          echo "   ğŸ“š Schedule: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/schedule/"
          echo "   ğŸ§  Quiz Management: http://${{ secrets.AWS_S3_BUCKET_NAME }}.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com/quiz/"
          echo ""
          echo "âœ… åŠŸèƒ½ç‰¹æ€§:"
          echo "   - Clerkèº«ä»½è®¤è¯: å®‰å…¨çš„ç”¨æˆ·æ³¨å†Œå’Œç™»å½•"
          echo "   - æ™ºèƒ½å˜åŒ–æ£€æµ‹: åªéƒ¨ç½²æœ‰å˜åŒ–çš„é¡¹ç›®"
          echo "   - æ¨¡å—åŒ–æ¶æ„: auth-clerk + shared + quiz"
          echo "   - ç®¡ç†å‘˜æƒé™: åŸºäºé‚®ç®±çš„ç®¡ç†å‘˜æ§åˆ¶"
          echo ""
          echo "ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®:"
          echo "   1. ä½¿ç”¨ç®¡ç†å‘˜é‚®ç®±ç™»å½•å¹¶æµ‹è¯•æƒé™"
          echo "   2. æµ‹è¯•ç”¨æˆ·æ³¨å†Œå’Œå®¡æ‰¹æµç¨‹"
          echo "   3. éªŒè¯é¢˜åº“è®¿é—®æƒé™æ§åˆ¶"
