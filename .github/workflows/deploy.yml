name: Deploy to Tencent COS

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. å®‰è£…å’Œé…ç½® coscmd å·¥å…·
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install coscmd
      run: |
        pip install coscmd
    
    # 3. é…ç½® coscmd
    - name: Configure coscmd
      run: |
        coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} \
                     -s ${{ secrets.TENCENT_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}
    
    # 4. åŒæ­¥æ–‡ä»¶åˆ° COS
    - name: Upload to COS
      run: |
        # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° COSï¼Œåˆ é™¤è¿œç¨‹å¤šä½™æ–‡ä»¶
        coscmd upload -r -s --delete ./ /
        
        # è®¾ç½® index.html çš„æ­£ç¡® Content-Type å’Œ Content-Disposition
        coscmd putobjectacl --grant-read "*" index.html || true
    
    # 5. è®¾ç½®æ–‡ä»¶çš„æ­£ç¡® Headersï¼ˆè§£å†³ä¸‹è½½é—®é¢˜ï¼‰
    - name: Set file headers
      run: |
        # ä¸º HTML æ–‡ä»¶è®¾ç½®æ­£ç¡®çš„ Content-Type
        find . -name "*.html" -type f | while read file; do
          filename=$(basename "$file")
          echo "Setting headers for $filename"
          # æ³¨æ„ï¼šcoscmd å¯èƒ½ä¸æ”¯æŒç›´æ¥è®¾ç½® headersï¼Œè¿™é‡Œä¸»è¦æ˜¯ç¡®ä¿æƒé™æ­£ç¡®
          coscmd putobjectacl --grant-read "*" "$filename" || true
        done
    
    # 6. è¾“å‡ºéƒ¨ç½²ç»“æœ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo "ç½‘ç«™åœ°å€: https://${{ secrets.COS_BUCKET }}.cos-website.${{ secrets.COS_REGION }}.myqcloud.com"
