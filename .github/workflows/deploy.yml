# .github/workflows/deploy.yml
name: Deploy Multi-Project to AWS S3

on:
  push:
    branches: [main]
    paths:
      - 'quiz/**'
      - 'videos/**'
      - 'admin/**'
      - 'schedule/**'
      - 'auth-clerk/**'
      - 'shared/**'
      - 'games/**'
      - 'index.html'
      - 'favicon.*'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: |
            quiz/package-lock.json
            videos/package-lock.json
            admin/package-lock.json
            auth-clerk/package-lock.json

      # 3. é…ç½® AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 4. æ£€æµ‹é¡¹ç›®å˜åŒ–ï¼ˆä¿®æ­£ç‰ˆ + adminï¼‰
      - name: Detect changed projects
        id: changes
        run: |
          echo "ğŸ” æ£€æµ‹é¡¹ç›®å˜åŒ–..."

          # æ£€æµ‹æ¯ä¸ªé¡¹ç›®çš„å˜åŒ–ï¼ˆæ·»åŠ adminï¼‰
          for project in schedule auth-clerk shared quiz videos admin; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^${project}/"; then
              echo "${project//-/_}_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… ${project} project has changes"
            else
              echo "${project//-/_}_changed=false" >> $GITHUB_OUTPUT
              echo "â– ${project} project has no changes"
            fi
          done

          # ä¾èµ–å…³ç³»å¤„ç†ï¼ˆä¿®æ­£å˜é‡å + adminï¼‰
          if [[ "$(cat $GITHUB_OUTPUT | grep -E 'auth_clerk_changed=true|shared_changed=true')" ]]; then
            echo "quiz_changed=true" >> $GITHUB_OUTPUT
            echo "videos_changed=true" >> $GITHUB_OUTPUT
            echo "admin_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Dependencies changed, forcing Quiz, Videos and Admin rebuild"
          fi

          # æ£€æµ‹æ ¹ç›®å½•æ–‡ä»¶å˜åŒ–
          if git diff --name-only HEAD~1 HEAD | grep -E '^(index\.html|games/)'; then
            echo "root_files_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Root files or games directory has changes"
          else
            echo "root_files_changed=false" >> $GITHUB_OUTPUT
            echo "â– Root files have no changes"
          fi

          # æ£€æµ‹å¼ºåˆ¶éƒ¨ç½²
          if [[ "${{ github.event.forced }}" == "true" ]] || [[ $(git rev-list --count HEAD) -le 1 ]] || [[ ! $(git diff --name-only HEAD~1 HEAD) ]]; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deploy mode - will deploy all projects"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi

      # 5. éƒ¨ç½² Schedule é¡¹ç›®ï¼ˆé™æ€æ–‡ä»¶ + ç¯å¢ƒå˜é‡ï¼‰
      - name: Deploy Schedule
        if: steps.changes.outputs.schedule_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        env:
          REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}
        run: |
          echo "ğŸš€ Deploying Schedule to /schedule path..."

          # å¤„ç†ç¯å¢ƒå˜é‡æ›¿æ¢
          if [ -f "./schedule/index.html" ]; then
            echo "ğŸ”§ Processing schedule HTML files for environment variables..."
            envsubst < "./schedule/index.html" > "./schedule/index.html.tmp" && mv "./schedule/index.html.tmp" "./schedule/index.html"
            echo "âœ… Environment variables processed"
          fi

          aws s3 sync ./schedule/ s3://damonxuda-projects/schedule/ \
            --delete \
            --exclude "*.md" \
            --exclude "README*" \
            --exclude "LICENSE*" \
            --exclude "package*.json" \
            --exclude "*.config.js" \
            --exclude "*.config.json" \
            --exclude ".gitignore" \
            --exclude ".eslintrc*" \
            --exclude ".prettierrc*"
          echo "âœ… Schedule deployed to /schedule path"
          echo "ğŸ“ Schedule: https://damonxuda.site/schedule/"

      # 6. æ„å»ºå¹¶éƒ¨ç½² Quiz é¡¹ç›®ï¼ˆReactåº”ç”¨ï¼‰
      - name: Install Quiz Dependencies
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸ“¦ Installing Quiz dependencies..."
          if [ -d "./quiz" ]; then
            cd quiz && npm ci
            cd ../auth-clerk && npm ci
            echo "âœ… Quiz dependencies installed"
          else
            echo "âš ï¸ Quiz directory not found"
          fi

      - name: Build Quiz Application
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./quiz
        run: |
          echo "ğŸ”§ Setting environment variables..."
          echo "REACT_APP_SUPABASE_URL=${{ secrets.REACT_APP_SUPABASE_URL }}" >> .env.production
          echo "REACT_APP_SUPABASE_ANON_KEY=${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}" >> .env.production
          echo "REACT_APP_CLERK_PUBLISHABLE_KEY=${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}" >> .env.production
          echo "REACT_APP_ADMIN_EMAILS=${{ secrets.REACT_APP_ADMIN_EMAILS }}" >> .env.production
          echo "GENERATE_SOURCEMAP=false" >> .env.production

          echo "ğŸ—ï¸ Building React application..."
          npm run build

      - name: Deploy Quiz to S3
        if: steps.changes.outputs.quiz_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "â˜ï¸ Deploying Quiz to S3..."
          aws s3 rm s3://damonxuda-projects/quiz/ --recursive
          aws s3 sync ./quiz/build/ s3://damonxuda-projects/quiz/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --exclude ".DS_Store"
          echo "âœ… Quiz deployed"
          echo "ğŸ“ Quiz: https://damonxuda.site/quiz/"

      # 7. æ„å»ºå¹¶éƒ¨ç½² Videos é¡¹ç›®ï¼ˆä¿®æ­£ä¸ºReacté¡¹ç›®ï¼‰
      - name: Install Videos Dependencies
        if: steps.changes.outputs.videos_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸ“¦ Installing Videos dependencies..."
          if [ -d "./videos" ]; then
            cd videos && npm ci
            cd ../auth-clerk && npm ci
            echo "âœ… Videos dependencies installed"
          else
            echo "âš ï¸ Videos directory not found"
          fi

      - name: Build Videos Application
        if: steps.changes.outputs.videos_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./videos
        env:
          REACT_APP_CLERK_PUBLISHABLE_KEY: ${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}
          REACT_APP_ADMIN_EMAILS: ${{ secrets.REACT_APP_ADMIN_EMAILS }}
          # æ–°çš„5å‡½æ•°æ¶æ„ - ä¸“é—¨åŒ–Lambdaå‡½æ•°
          REACT_APP_FILE_MANAGEMENT_API_URL: ${{ secrets.REACT_APP_FILE_MANAGEMENT_API_URL }}
          REACT_APP_THUMBNAIL_GENERATOR_API_URL: ${{ secrets.REACT_APP_THUMBNAIL_GENERATOR_API_URL }}
          REACT_APP_FORMAT_CONVERTER_API_URL: ${{ secrets.REACT_APP_FORMAT_CONVERTER_API_URL }}
          REACT_APP_VIDEO_PLAYER_API_URL: ${{ secrets.REACT_APP_VIDEO_PLAYER_API_URL }}
          REACT_APP_YOUTUBE_MANAGER_API_URL: ${{ secrets.REACT_APP_YOUTUBE_MANAGER_API_URL }}
          REACT_APP_SUBTITLE_API_URL: ${{ secrets.REACT_APP_SUBTITLE_API_URL }}
          # æ—§çš„3å‡½æ•°æ¶æ„ - å‘åå…¼å®¹
          REACT_APP_VIDEO_CORE_API_URL: ${{ secrets.REACT_APP_VIDEO_CORE_API_URL }}
          REACT_APP_VIDEO_PROCESSING_API_URL: ${{ secrets.REACT_APP_VIDEO_PROCESSING_API_URL }}
          REACT_APP_YOUTUBE_API_URL: ${{ secrets.REACT_APP_YOUTUBE_API_URL }}
          REACT_APP_VIDEO_API_URL: ${{ secrets.REACT_APP_VIDEO_CORE_API_URL }}
          REACT_APP_USER_MANAGEMENT_API_URL: ${{ secrets.REACT_APP_USER_MANAGEMENT_API_URL }}
          GENERATE_SOURCEMAP: false
        run: |
          echo "ğŸ—ï¸ Building Videos React application..."
          npm run build

      - name: Deploy Videos to S3
        if: steps.changes.outputs.videos_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "â˜ï¸ Deploying Videos to damonxuda-projects bucket..."
          aws s3 rm s3://damonxuda-projects/videos/ --recursive
          aws s3 sync ./videos/build/ s3://damonxuda-projects/videos/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --exclude ".DS_Store"
          echo "âœ… Videos deployed to damonxuda-projects bucket"
          echo "ğŸ“ Videos: https://damonxuda.site/videos/"

      # 8. æ„å»ºå¹¶éƒ¨ç½² Admin é¡¹ç›®
      - name: Install Admin Dependencies
        if: steps.changes.outputs.admin_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "ğŸ“¦ Installing Admin dependencies..."
          if [ -d "./admin" ]; then
            cd admin && npm ci
            cd ../auth-clerk && npm ci
            echo "âœ… Admin dependencies installed"
          else
            echo "âš ï¸ Admin directory not found"
          fi

      - name: Build Admin Application
        if: steps.changes.outputs.admin_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        working-directory: ./admin
        env:
          CI: false
        run: |
          echo "ğŸ”§ Setting environment variables..."
          echo "REACT_APP_CLERK_PUBLISHABLE_KEY=${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}" >> .env.production
          # å¾®æœåŠ¡æ¶æ„ - å¤šä¸ªLambda URL
          echo "REACT_APP_VIDEO_CORE_API_URL=${{ secrets.REACT_APP_VIDEO_CORE_API_URL }}" >> .env.production
          echo "REACT_APP_VIDEO_PROCESSING_API_URL=${{ secrets.REACT_APP_VIDEO_PROCESSING_API_URL }}" >> .env.production
          echo "REACT_APP_YOUTUBE_API_URL=${{ secrets.REACT_APP_YOUTUBE_API_URL }}" >> .env.production
          # å‘åå…¼å®¹ - é»˜è®¤ä½¿ç”¨video-core
          echo "REACT_APP_VIDEO_API_URL=${{ secrets.REACT_APP_VIDEO_CORE_API_URL }}" >> .env.production
          echo "REACT_APP_USER_MANAGEMENT_API_URL=${{ secrets.REACT_APP_USER_MANAGEMENT_API_URL }}" >> .env.production
          echo "REACT_APP_ADMIN_EMAILS=${{ secrets.REACT_APP_ADMIN_EMAILS }}" >> .env.production
          echo "GENERATE_SOURCEMAP=false" >> .env.production

          echo "ğŸ—ï¸ Building Admin React application..."
          npm run build

      - name: Deploy Admin to S3
        if: steps.changes.outputs.admin_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        run: |
          echo "â˜ï¸ Deploying Admin to S3..."
          aws s3 rm s3://damonxuda-projects/admin/ --recursive
          aws s3 sync ./admin/build/ s3://damonxuda-projects/admin/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --exclude ".DS_Store"
          echo "âœ… Admin deployed"
          echo "ğŸ“ Admin: https://damonxuda.site/admin/"

      # 9. éªŒè¯éƒ¨ç½²å’ŒClerkè®¤è¯
      - name: Verify Clerk Authentication Setup
        run: |
          echo "ğŸ” === Clerkè®¤è¯ç³»ç»ŸéªŒè¯ ==="
          echo ""
          echo "ğŸ” 1. æ£€æŸ¥ S3 ä¸Šçš„ quiz æ–‡ä»¶:"
          aws s3 ls s3://damonxuda-projects/quiz/ --recursive --summarize || echo "Quiz files not found"
          echo ""
          echo "ğŸ” 2. æ£€æŸ¥ Videos æ–‡ä»¶:"
          aws s3 ls s3://damonxuda-projects/videos/ --recursive || echo "Videos files not found"
          echo ""
          echo "ğŸ” 3. æ£€æŸ¥ Admin æ–‡ä»¶:"
          aws s3 ls s3://damonxuda-projects/admin/ --recursive || echo "Admin files not found"

      # 10. éƒ¨ç½²æ ¹ç›®å½•æ–‡ä»¶å’Œgamesç›®å½•
      - name: Deploy root files
        if: steps.changes.outputs.root_files_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        env:
          CLERK_PUBLISHABLE_KEY: ${{ secrets.REACT_APP_CLERK_PUBLISHABLE_KEY }}
          REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸš€ Deploying root directory files..."
          if [ -f "./index.html" ]; then
            echo "ğŸ”§ Replacing environment variables in index.html..."
            envsubst < ./index.html > ./index.html.tmp && mv ./index.html.tmp ./index.html
            aws s3 cp ./index.html s3://damonxuda-projects/index.html
            echo "âœ… Root index.html deployed with environment variables"
          else
            echo "â„¹ï¸ No root index.html found"
          fi
          
          # éƒ¨ç½²faviconæ–‡ä»¶
          if [ -f "./favicon.svg" ]; then
            aws s3 cp ./favicon.svg s3://damonxuda-projects/favicon.svg
            echo "âœ… favicon.svg deployed"
          else
            echo "â„¹ï¸ No favicon.svg found"
          fi
          
          if [ -f "./favicon.ico" ]; then
            aws s3 cp ./favicon.ico s3://damonxuda-projects/favicon.ico
            echo "âœ… favicon.ico deployed"
          else
            echo "â„¹ï¸ No favicon.ico found"
          fi
          
          if [ -d "./games" ]; then
            echo "ğŸ® Deploying games directory..."

            # ä¸ºgamesç›®å½•ä¸­çš„HTMLæ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡
            echo "ğŸ”§ Processing games HTML files for environment variables..."
            find ./games -name "*.html" -type f | while read file; do
              echo "Processing: $file"
              envsubst < "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            done

            # éƒ¨ç½²HTMLæ–‡ä»¶ï¼ˆä¸ç¼“å­˜ï¼‰
            echo "ğŸ“¤ Deploying HTML files with no-cache headers..."
            find ./games -name "*.html" -type f | while read file; do
              s3_path="s3://damonxuda-projects/${file#./}"
              aws s3 cp "$file" "$s3_path" \
                --cache-control "no-cache, no-store, must-revalidate" \
                --metadata-directive REPLACE
            done

            # éƒ¨ç½²å…¶ä»–æ–‡ä»¶ï¼ˆæ­£å¸¸ç¼“å­˜ï¼‰
            echo "ğŸ“¤ Deploying other files..."
            aws s3 sync ./games/ s3://damonxuda-projects/games/ \
              --delete \
              --exclude "*.html" \
              --exclude ".DS_Store"
            echo "âœ… Games directory deployed with environment variables"
          else
            echo "â„¹ï¸ No games directory found"
          fi

      # 11. CloudFront ç¼“å­˜æ¸…é™¤ï¼ˆä»… /schedule å’Œ /gamesï¼‰
      - name: Invalidate CloudFront Cache
        if: steps.changes.outputs.schedule_changed == 'true' || steps.changes.outputs.root_files_changed == 'true' || steps.changes.outputs.force_deploy == 'true'
        env:
          CLOUDFRONT_DISTRIBUTION_ID: E3JLLPNZWYQBZQ
        run: |
          echo "ğŸ”„ æ¸…é™¤ CloudFront ç¼“å­˜..."

          PATHS=""

          # æ£€æŸ¥ schedule æ˜¯å¦å˜åŒ–
          if [[ "${{ steps.changes.outputs.schedule_changed }}" == "true" ]] || [[ "${{ steps.changes.outputs.force_deploy }}" == "true" ]]; then
            PATHS="$PATHS /schedule/*"
            echo "  âœ… å°†æ¸…é™¤ /schedule/* ç¼“å­˜"
          fi

          # æ£€æŸ¥ games æ˜¯å¦å˜åŒ–ï¼ˆåŒ…å«åœ¨ root_files_changed ä¸­ï¼‰
          if [[ "${{ steps.changes.outputs.root_files_changed }}" == "true" ]] || [[ "${{ steps.changes.outputs.force_deploy }}" == "true" ]]; then
            # ä½¿ç”¨æ›´å®½æ¾çš„æ£€æŸ¥ï¼šåªè¦ root_files_changed å°±æ¸…é™¤ games
            PATHS="$PATHS /games/*"
            echo "  âœ… å°†æ¸…é™¤ /games/* ç¼“å­˜"
          fi

          # å¦‚æœæœ‰éœ€è¦æ¸…é™¤çš„è·¯å¾„ï¼Œåˆ›å»º invalidation
          if [ -n "$PATHS" ]; then
            echo "ğŸš€ åˆ›å»º CloudFront invalidation..."
            echo "ğŸ“‹ æ¸…é™¤è·¯å¾„: $PATHS"
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --paths $PATHS
            echo "âœ… CloudFront ç¼“å­˜æ¸…é™¤è¯·æ±‚å·²æäº¤"
            echo "â³ æ³¨æ„ï¼šCloudFront invalidation å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿç”Ÿæ•ˆ"
          else
            echo "â„¹ï¸ æ— éœ€æ¸…é™¤ç¼“å­˜"
          fi

      # 12. éªŒè¯æ‰€æœ‰éƒ¨ç½²ç»“æœ
      - name: Verify all deployments
        run: |
          echo "ğŸ“ éªŒè¯æ‰€æœ‰é¡¹ç›®éƒ¨ç½²..."

          echo "=== Schedule ==="
          aws s3 ls s3://damonxuda-projects/schedule/ --recursive | head -3 || echo "âŒ Schedule not found"

          echo "=== Quiz ==="
          aws s3 ls s3://damonxuda-projects/quiz/ --recursive | head -3 || echo "âŒ Quiz not found"

          echo "=== Videos ==="
          aws s3 ls s3://damonxuda-projects/videos/ --recursive | head -3 || echo "âŒ Videos not found"

          echo "=== Admin ==="
          aws s3 ls s3://damonxuda-projects/admin/ --recursive | head -3 || echo "âŒ Admin not found"

      # 13. éƒ¨ç½²æˆåŠŸæŠ¥å‘Š
      - name: Deploy Success Report
        run: |
          echo "ğŸ‰ å¤šé¡¹ç›®éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ‘˜è¦:"
          echo "   Schedule: ${{ steps.changes.outputs.schedule_changed }}"
          echo "   Auth-clerk: ${{ steps.changes.outputs.auth_clerk_changed }}"
          echo "   Shared: ${{ steps.changes.outputs.shared_changed }}"
          echo "   Quiz: ${{ steps.changes.outputs.quiz_changed }}"
          echo "   Videos: ${{ steps.changes.outputs.videos_changed }}"
          echo "   Admin: ${{ steps.changes.outputs.admin_changed }}"
          echo "   å¼ºåˆ¶éƒ¨ç½²: ${{ steps.changes.outputs.force_deploy }}"
          echo ""
          echo "ğŸŒ é¡¹ç›®è®¿é—®åœ°å€:"
          echo "   ğŸ“š Schedule: https://damonxuda.site/schedule/"
          echo "   ğŸ§  Quiz: https://damonxuda.site/quiz/"
          echo "   ğŸ¬ Videos: https://damonxuda.site/videos/"
          echo "   ğŸ›¡ï¸ Admin: https://damonxuda.site/admin/"
          echo ""
          echo "âœ… éƒ¨ç½²å®Œæˆï¼æ‰€æœ‰é¡¹ç›®ç°å·²éƒ¨ç½²åˆ° damonxuda-projects bucket!"
