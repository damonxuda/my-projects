name: Deploy to Tencent COS

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # 3. å®‰è£… COSCMD
    - name: Install coscmd
      run: |
        pip install coscmd
        echo "COSCMD installed successfully"
    
    # 4. é…ç½® COSCMD
    - name: Configure coscmd
      run: |
        coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} \
                     -s ${{ secrets.TENCENT_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}
        echo "COSCMD configured successfully"
    
    # 5. ä¸Šä¼ æ‰€æœ‰é™æ€æ–‡ä»¶å¹¶è®¾ç½®å…¬æœ‰è¯»æƒé™
    - name: Upload all static files with public-read permissions
      run: |
        echo "Uploading all static files with public-read permissions..."
        
        # åŒæ­¥ä¸Šä¼ æ‰€æœ‰é™æ€ç½‘ç«™æ–‡ä»¶ï¼Œè®¾ç½®å…¬æœ‰è¯»æƒé™ï¼Œå¹¶æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        coscmd upload -rs -f -H "{'x-cos-acl':'public-read'}" ./ / \
          --ignore ".git/*,.github/*,node_modules/*,.DS_Store,*.md,README*,LICENSE*,*.yml,*.yaml,.env*,*.zip,*.tar,*.gz,package*.json,tsconfig.json,webpack.config.js,gulpfile.js,Gruntfile.js,.gitignore,.gitattributes,.editorconfig,.eslintrc*,.prettierrc*,*.log"
        
        echo "âœ… All static files uploaded with public-read permissions"
        echo "ğŸ“ Supported file types: HTML, CSS, JS, PNG, JPG, GIF, SVG, WOFF, TTF, JSON, XML, PDF, etc."
    
    # 6. è®¾ç½®å­˜å‚¨æ¡¶é™æ€ç½‘ç«™é…ç½®ï¼ˆè§£å†³ä¸‹è½½é—®é¢˜ï¼‰
    - name: Configure static website hosting
      run: |
        echo "Configuring static website hosting..."
        
        # å°è¯•è®¾ç½®å­˜å‚¨æ¡¶ä¸ºé™æ€ç½‘ç«™æ¨¡å¼ï¼ˆå¯èƒ½éœ€è¦æ‰‹åŠ¨åœ¨æ§åˆ¶å°è®¾ç½®ï¼‰
        echo "Note: Make sure static website hosting is enabled in COS console"
        echo "Index document should be set to: index.html"
        echo "Error document can be set to: 404.html or index.html"
    
    # 7. ç‰¹æ®Šå¤„ç† index.html çš„ Content-Disposition
    - name: Set index.html Content-Disposition and headers
      run: |
        echo "Setting Content-Disposition and headers for index.html..."
        
        # é‡æ–°ä¸Šä¼  index.html å¹¶è®¾ç½®ç®€åŒ–çš„å¤´éƒ¨ä¿¡æ¯ï¼ˆåŸºäºå®é™…æˆåŠŸç»éªŒï¼‰
        coscmd upload -f -H "{'x-cos-acl':'public-read','Content-Type':'text/html','Content-Disposition':'inline'}" index.html /index.html
        
        echo "âœ… index.html Content-Disposition set to inline with simplified headers"
    
    # 8. éªŒè¯ä¸Šä¼ ç»“æœ
    - name: Verify upload and timestamps
      run: |
        echo "Verifying uploaded files and timestamps..."
        coscmd list -ar
        
        echo "Checking specific files info..."
        coscmd info index.html || echo "Could not get index.html info"
        coscmd info css/styles.css || echo "Could not get styles.css info"
        coscmd info js/app.js || echo "Could not get app.js info"
        coscmd info js/config.js || echo "Could not get config.js info"
        
        echo "Upload verification completed"
    
    # 8. å¤‡ç”¨æƒé™è®¾ç½®ï¼ˆå¦‚æœä¸Šè¿°æ–¹æ³•ä¸ç”Ÿæ•ˆï¼‰
    - name: Backup permission setting
      continue-on-error: true
      run: |
        echo "Setting backup permissions for all uploaded files..."
        
        # è·å–æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶è®¾ç½®æƒé™
        coscmd list -ar | grep -v "^Directory" | awk '{print $NF}' | while read file; do
          if [ -n "$file" ] && [ "$file" != "." ]; then
            echo "Setting permissions for: $file"
            coscmd putobjectacl --grant-read "*" "$file" || echo "Failed to set permissions for $file"
          fi
        done
    
    # 10. éƒ¨ç½²æˆåŠŸ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo ""
        echo "ğŸ“ ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
        coscmd list -ar | head -20
        echo ""
        echo "ğŸŒ è¯·ä½¿ç”¨é™æ€ç½‘ç«™åŸŸåè®¿é—®ï¼ˆé‡è¦ï¼‰:"
        echo "   âœ… é™æ€ç½‘ç«™åŸŸå: https://${{ secrets.COS_BUCKET }}.cos-website.${{ secrets.COS_REGION }}.myqcloud.com"
        echo "   âŒ ç›´æ¥è®¿é—®åŸŸå: https://${{ secrets.COS_BUCKET }}.cos.${{ secrets.COS_REGION }}.myqcloud.com ï¼ˆä¼šä¸‹è½½æ–‡ä»¶ï¼‰"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²åŒæ­¥å¹¶è®¾ç½®ä¸ºå…¬æœ‰è¯»ç§æœ‰å†™æƒé™"
        echo "âœ… index.html å·²è®¾ç½® Content-Disposition: inline"
        echo "âœ… ä½¿ç”¨åŒæ­¥æ¨¡å¼ï¼Œåªä¸Šä¼ å˜åŒ–çš„æ–‡ä»¶"
        echo ""
        echo "âš ï¸  å¦‚æœé™æ€ç½‘ç«™åŸŸåä»ç„¶ä¸‹è½½è€Œä¸æ˜¯æ˜¾ç¤ºï¼Œè¯·åœ¨COSæ§åˆ¶å°æ£€æŸ¥ï¼š"
        echo "   1. åŸºç¡€é…ç½® â†’ é™æ€ç½‘ç«™ â†’ ç¡®ä¿å·²å¼€å¯"
        echo "   2. ç´¢å¼•æ–‡æ¡£è®¾ç½®ä¸º: index.html"
        echo "   3. é”™è¯¯æ–‡æ¡£å¯è®¾ç½®ä¸º: index.html æˆ– 404.html"
