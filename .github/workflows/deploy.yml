name: Deploy to Tencent COS

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # 3. å®‰è£… COSCMD
    - name: Install coscmd
      run: |
        pip install coscmd
        echo "COSCMD installed successfully"
    
    # 4. é…ç½® COSCMD
    - name: Configure coscmd
      run: |
        coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} \
                     -s ${{ secrets.TENCENT_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}
        echo "COSCMD configured successfully"
    
    # 5. ä¸Šä¼ æ‰€æœ‰é™æ€æ–‡ä»¶å¹¶è®¾ç½®å…¬æœ‰è¯»æƒé™
    - name: Upload all static files with public-read permissions
      run: |
        echo "Uploading all static files with public-read permissions..."
        
        # ä¸Šä¼ æ‰€æœ‰é™æ€ç½‘ç«™æ–‡ä»¶ï¼Œè®¾ç½®å…¬æœ‰è¯»æƒé™ï¼Œå¹¶æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        coscmd upload -rs -f -H "{'x-cos-acl':'public-read'}" ./ / \
          --ignore ".git/*,.github/*,node_modules/*,.DS_Store,*.md,README*,LICENSE*,*.yml,*.yaml,.env*,*.zip,*.tar,*.gz,package*.json,tsconfig.json,webpack.config.js,gulpfile.js,Gruntfile.js,.gitignore,.gitattributes,.editorconfig,.eslintrc*,.prettierrc*,*.log"
        
        echo "âœ… All static files uploaded with public-read permissions"
        echo "ğŸ“ Supported file types: HTML, CSS, JS, PNG, JPG, GIF, SVG, WOFF, TTF, JSON, XML, PDF, etc."
    
    # 6. ç‰¹æ®Šå¤„ç† index.html çš„ Content-Disposition
    - name: Set index.html Content-Disposition
      run: |
        echo "Setting Content-Disposition for index.html..."
        
        # é‡æ–°ä¸Šä¼  index.htmlï¼Œåœ¨ä¿æŒå…¬æœ‰è¯»æƒé™çš„åŒæ—¶æ·»åŠ  Content-Disposition
        coscmd upload -f -H "{'x-cos-acl':'public-read','Content-Disposition':'inline','Content-Type':'text/html'}" index.html /index.html
        
        echo "âœ… index.html Content-Disposition set to inline"
    
    # 7. éªŒè¯ä¸Šä¼ ç»“æœ
    - name: Verify upload
      run: |
        echo "Verifying uploaded files..."
        coscmd list -ar
        
        echo "Checking index.html info..."
        coscmd info index.html || echo "Could not get index.html info"
        
        echo "Upload verification completed"
    
    # 8. å¤‡ç”¨æƒé™è®¾ç½®ï¼ˆå¦‚æœä¸Šè¿°æ–¹æ³•ä¸ç”Ÿæ•ˆï¼‰
    - name: Backup permission setting
      continue-on-error: true
      run: |
        echo "Setting backup permissions for all uploaded files..."
        
        # è·å–æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶è®¾ç½®æƒé™
        coscmd list -ar | grep -v "^Directory" | awk '{print $NF}' | while read file; do
          if [ -n "$file" ] && [ "$file" != "." ]; then
            echo "Setting permissions for: $file"
            coscmd putobjectacl --grant-read "*" "$file" || echo "Failed to set permissions for $file"
          fi
        done
    
    # 9. éƒ¨ç½²æˆåŠŸ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo ""
        echo "ğŸ“ ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
        coscmd list -ar | head -20
        echo ""
        echo "ğŸŒ ç½‘ç«™åœ°å€: https://${{ secrets.COS_BUCKET }}.cos-website.${{ secrets.COS_REGION }}.myqcloud.com"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²è®¾ç½®ä¸ºå…¬æœ‰è¯»ç§æœ‰å†™æƒé™"
        echo "âœ… index.html å·²è®¾ç½® Content-Disposition: inline"
        echo "âœ… æ”¯æŒæ‰€æœ‰é™æ€ç½‘ç«™æ–‡ä»¶ç±»å‹"
