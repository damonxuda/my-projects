name: Deploy to Tencent COS
# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. å®‰è£…å’Œé…ç½® coscmd å·¥å…·
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install coscmd
      run: |
        pip install coscmd
    
    # 3. é…ç½® coscmd
    - name: Configure coscmd
      run: |
        coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} \
                     -s ${{ secrets.TENCENT_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}
    
    # 4. å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶
    - name: Prepare files for upload
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•ï¼Œåªå¤åˆ¶éœ€è¦çš„æ–‡ä»¶
        mkdir -p ./deploy-temp
        
        # å¤åˆ¶ç½‘ç«™æ–‡ä»¶
        cp index.html ./deploy-temp/ 2>/dev/null || true
        cp -r css ./deploy-temp/ 2>/dev/null || true
        cp -r js ./deploy-temp/ 2>/dev/null || true
        cp -r images ./deploy-temp/ 2>/dev/null || true
        cp -r assets ./deploy-temp/ 2>/dev/null || true
        
        # æ˜¾ç¤ºè¦ä¸Šä¼ çš„æ–‡ä»¶
        echo "Files to upload:"
        find ./deploy-temp -type f
    
    # 5. è®¾ç½®å­˜å‚¨æ¡¶æƒé™
    - name: Set bucket permissions
      run: |
        # è®¾ç½®å­˜å‚¨æ¡¶ä¸ºå…¬æœ‰è¯»ç§æœ‰å†™
        echo "Setting bucket to public-read..."
        coscmd putbucketacl --grant-read uri=http://cam.qcloud.com/groups/global/AllUsers
        echo "Bucket permissions set successfully!"
    
    # 6. åŒæ­¥æ–‡ä»¶åˆ° COS
    - name: Upload to COS
      run: |
        # ä¸Šä¼ å‡†å¤‡å¥½çš„æ–‡ä»¶åˆ° COSï¼Œè‡ªåŠ¨ç¡®è®¤åˆ é™¤
        cd deploy-temp
        echo "y" | coscmd upload -r -s --delete ./ /
        
        # è®¾ç½® index.html çš„æ­£ç¡®æƒé™
        coscmd putobjectacl --grant-read "*" index.html || true
    
    # 7. è®¾ç½®æ–‡ä»¶çš„æ­£ç¡® Headers
    - name: Set file headers
      run: |
        # ä¸º HTML æ–‡ä»¶è®¾ç½®æ­£ç¡®çš„æƒé™
        coscmd putobjectacl --grant-read "*" index.html || true
        
        # ä¸ºå…¶ä»–æ–‡ä»¶è®¾ç½®æƒé™
        find ./deploy-temp -name "*.html" -type f | while read file; do
          filename=$(basename "$file")
          echo "Setting permissions for $filename"
          coscmd putobjectacl --grant-read "*" "$filename" || true
        done
    
    # 8. ç¡®è®¤å­˜å‚¨æ¡¶æƒé™
    - name: Verify bucket permissions
      run: |
        echo "Verifying bucket permissions..."
        coscmd getbucketacl || true
        echo "Deployment completed!"
    
    # 9. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    - name: Cleanup
      run: |
        rm -rf ./deploy-temp
    
    # 10. è¾“å‡ºéƒ¨ç½²ç»“æœ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo "ç½‘ç«™åœ°å€: https://${{ secrets.COS_BUCKET }}.cos-website.${{ secrets.COS_REGION }}.myqcloud.com"
