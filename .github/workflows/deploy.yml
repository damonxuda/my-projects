name: Deploy to Tencent COS

# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm ci
    
    # 4. æ„å»ºé¡¹ç›®
    - name: Build project
      run: npm run build
    
    # 5. å®‰è£… COSCMD
    - name: Install coscmd
      run: |
        pip install coscmd
        echo "COSCMD installed successfully"
    
    # 6. é…ç½® COSCMD
    - name: Configure coscmd
      run: |
        coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} \
                     -s ${{ secrets.TENCENT_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}
        echo "COSCMD configured successfully"
    
    # 7. å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶
    - name: Prepare files for upload
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•ï¼Œåªå¤åˆ¶éœ€è¦çš„æ–‡ä»¶
        mkdir -p ./deploy-temp
        
        # å¤åˆ¶ç½‘ç«™æ–‡ä»¶
        cp index.html ./deploy-temp/ 2>/dev/null || true
        cp -r css ./deploy-temp/ 2>/dev/null || true
        cp -r js ./deploy-temp/ 2>/dev/null || true
        cp -r images ./deploy-temp/ 2>/dev/null || true
        cp -r assets ./deploy-temp/ 2>/dev/null || true
        
        # æ˜¾ç¤ºè¦ä¸Šä¼ çš„æ–‡ä»¶
        echo "Files to upload:"
        find ./deploy-temp -type f
    
    # 8. ä¸Šä¼ æ–‡ä»¶å¹¶è®¾ç½®æƒé™ï¼ˆå…³é”®æ”¹è¿›ï¼‰
    - name: Upload to COS with permissions
      run: |
        echo "Uploading files with public-read permissions..."
        cd deploy-temp
        
        # æ ¸å¿ƒæ”¹è¿›ï¼šä¸Šä¼ æ—¶ç›´æ¥è®¾ç½®ACLæƒé™ï¼Œé¿å…åç»­æƒé™è®¾ç½®å¤±è´¥
        coscmd upload -rs -f -H "{'x-cos-acl':'public-read'}" ./ /
        
        echo "Upload completed successfully"
    
    # 9. ç‰¹æ®Šå¤„ç† index.html çš„ Content-Disposition
    - name: Fix index.html Content-Disposition
      run: |
        echo "Setting Content-Disposition for index.html..."
        cd deploy-temp
        
        # é‡æ–°ä¸Šä¼  index.html å¹¶è®¾ç½®æ­£ç¡®çš„ Content-Disposition å’Œæƒé™
        coscmd upload -f -H "{'x-cos-acl':'public-read','Content-Disposition':'inline','Content-Type':'text/html'}" index.html /index.html
        
        echo "index.html Content-Disposition and permissions fixed"
    
    # 9. éªŒè¯ä¸Šä¼ ç»“æœ
    - name: Verify upload
      run: |
        echo "Verifying uploaded files..."
        coscmd list -ar
        
        echo "Checking index.html info..."
        coscmd info index.html || echo "Could not get index.html info"
    
    # 10. å¤‡ç”¨æƒé™è®¾ç½®ï¼ˆå¦‚æœä¸Šè¿°æ–¹æ³•ä¸ç”Ÿæ•ˆï¼‰
    - name: Backup permission setting
      continue-on-error: true
      run: |
        echo "Setting backup file permissions..."
        
        # ä¸ºå…³é”®æ–‡ä»¶å•ç‹¬è®¾ç½®æƒé™ï¼ˆä¿æŒä½ åŸæ¥çš„è¯­æ³•ï¼‰
        coscmd putobjectacl --grant-read "*" index.html || echo "Failed to set index.html permissions"
        
        # ä¸ºå…¶ä»–HTMLæ–‡ä»¶è®¾ç½®æƒé™
        find ./deploy-temp -name "*.html" -type f | while read file; do
          filename=$(basename "$file")
          echo "Setting permissions for $filename"
          coscmd putobjectacl --grant-read "*" "$filename" || echo "Failed to set $filename permissions"
        done
    
    # 11. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    - name: Cleanup
      run: |
        rm -rf ./deploy-temp
    
    # 12. è¾“å‡ºéƒ¨ç½²ç»“æœ
    - name: Deploy Success
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo "ç½‘ç«™åœ°å€: https://${{ secrets.COS_BUCKET }}.cos-website.${{ secrets.COS_REGION }}.myqcloud.com"
