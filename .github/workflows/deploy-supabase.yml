# .github/workflows/deploy-supabase.yml
name: Deploy Supabase Edge Functions

on:
  push:
    branches: [main]
    paths:
      - 'backend/supabase/functions/**'
      - 'backend/supabase/config.toml'
      - '.github/workflows/deploy-supabase.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno (Supabase Edge Functionsä½¿ç”¨Deno)
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set environment variables
        working-directory: ./backend/supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "ğŸ”§ Setting environment variables for Edge Functions..."

          # ä¸ºæ¸¸æˆå‡½æ•°è®¾ç½® MongoDB è¿æ¥ä¿¡æ¯
          supabase secrets set MONGODB_ATLAS_URI='${{ secrets.MONGODB_ATLAS_URI }}' --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase secrets set MONGODB_DB_NAME='${{ secrets.MONGODB_DB_NAME }}' --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

          # ä¸ºäº¤æ˜“APIè®¾ç½®ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨
          supabase secrets set ADMIN_EMAILS='${{ secrets.ADMIN_EMAILS }}' --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

          # æ³¨æ„ï¼šSUPABASE_URL å’Œ SUPABASE_SERVICE_ROLE_KEY ç”± Supabase è‡ªåŠ¨æä¾›ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®

          echo "âœ… Environment variables configured!"

      - name: Deploy Edge Functions
        working-directory: ./backend/supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "ğŸš€ Deploying Edge Functions..."

          # è·å–æ‰€æœ‰å‡½æ•°ç›®å½•
          for func_dir in functions/*/; do
            if [ -d "$func_dir" ]; then
              func_name=$(basename "$func_dir")
              echo "ğŸ“¦ Deploying function: $func_name"

              # ä½¿ç”¨ --project-ref ç›´æ¥éƒ¨ç½²ï¼Œæ— éœ€å…ˆ link
              supabase functions deploy "$func_name" --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

              echo "âœ… $func_name deployed successfully!"
            fi
          done

      - name: Verify deployment
        working-directory: ./backend/supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "ğŸ§ª Verifying deployment..."
          # åˆ—å‡ºæ‰€æœ‰å·²éƒ¨ç½²çš„å‡½æ•°
          supabase functions list --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

          echo "âœ… Deployment verification completed!"
