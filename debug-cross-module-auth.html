<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨æ¨¡å—è®¤è¯è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #3c3c3c; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #4fc3f7; }
        .log { background: #2d2d2d; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .error { color: #f48771; }
        .success { color: #81c784; }
        .warning { color: #ffb74d; }
        .button { padding: 10px 20px; margin: 5px; background: #0d7377; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #14a085; }
        .status { display: inline-block; padding: 5px 10px; border-radius: 3px; margin: 5px 0; }
        .status.ok { background: #1b5e20; color: #c8e6c9; }
        .status.error { background: #b71c1c; color: #ffcdd2; }
        .status.warn { background: #e65100; color: #ffe0b2; }
    </style>
</head>
<body>
    <h1>ğŸ” è·¨æ¨¡å—è®¤è¯è°ƒè¯•å·¥å…·</h1>
    <p>è¿™ä¸ªå·¥å…·å¸®åŠ©è¯Šæ–­è·¨æ¨¡å—è®¤è¯é—®é¢˜</p>

    <div class="section">
        <h3>ğŸ“‹ å¿«é€Ÿè¯Šæ–­</h3>
        <button class="button" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <button class="button" onclick="clearLocalStorage()">æ¸…ç†LocalStorage</button>
        <button class="button" onclick="simulateCrossModule()">æ¨¡æ‹Ÿè·¨æ¨¡å—è·³è½¬</button>
    </div>

    <div class="section">
        <h3>ğŸ”— LocalStorage çŠ¶æ€</h3>
        <div id="localStorage-status"></div>
    </div>

    <div class="section">
        <h3>ğŸŒ Clerk çŠ¶æ€</h3>
        <div id="clerk-status"></div>
    </div>

    <div class="section">
        <h3>ğŸ“ URL å‚æ•°</h3>
        <div id="url-params"></div>
    </div>

    <div class="section">
        <h3>ğŸ”§ è°ƒè¯•æ—¥å¿—</h3>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        let logDiv = document.getElementById('debug-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warn' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function checkLocalStorage() {
            const div = document.getElementById('localStorage-status');
            let html = '';

            try {
                const clerkEnv = localStorage.getItem('__clerk_environment');
                if (clerkEnv) {
                    const data = JSON.parse(clerkEnv);
                    html += '<div class="status ok">âœ… __clerk_environment å­˜åœ¨</div>';
                    html += `<div>ç”¨æˆ·ID: ${data.user?.id || 'æœªè®¾ç½®'}</div>`;
                    html += `<div>é‚®ç®±: ${data.user?.emailAddresses?.[0]?.emailAddress || 'æœªè®¾ç½®'}</div>`;
                    html += `<div>ä¼šè¯ID: ${data.session?.id || 'æœªè®¾ç½®'}</div>`;
                    html += `<div>ä¼šè¯çŠ¶æ€: ${data.session?.status || 'æœªè®¾ç½®'}</div>`;
                } else {
                    html += '<div class="status error">âŒ __clerk_environment ä¸å­˜åœ¨</div>';
                }

                // æ£€æŸ¥å…¶ä»–ç›¸å…³çš„localStorageé¡¹
                const allKeys = Object.keys(localStorage).filter(key =>
                    key.includes('clerk') || key.includes('auth')
                );
                if (allKeys.length > 0) {
                    html += '<div style="margin-top: 10px;"><strong>å…¶ä»–è®¤è¯ç›¸å…³é”®:</strong></div>';
                    allKeys.forEach(key => {
                        html += `<div>â€¢ ${key}</div>`;
                    });
                }
            } catch (error) {
                html += '<div class="status error">âŒ localStorage è§£æé”™è¯¯</div>';
                log(`LocalStorage è§£æé”™è¯¯: ${error.message}`, 'error');
            }

            div.innerHTML = html;
        }

        function checkClerkStatus() {
            const div = document.getElementById('clerk-status');
            let html = '';

            if (typeof window.Clerk !== 'undefined') {
                html += '<div class="status ok">âœ… Clerk SDK å·²åŠ è½½</div>';
                html += `<div>ç”¨æˆ·çŠ¶æ€: ${window.Clerk.user ? 'å·²ç™»å½•' : 'æœªç™»å½•'}</div>`;

                if (window.Clerk.user) {
                    html += `<div>ç”¨æˆ·é‚®ç®±: ${window.Clerk.user.emailAddresses?.[0]?.emailAddress || 'æœªçŸ¥'}</div>`;
                }

                if (window.Clerk.session) {
                    html += `<div>ä¼šè¯çŠ¶æ€: æ´»è·ƒ</div>`;
                    html += `<div>ä¼šè¯ID: ${window.Clerk.session.id || 'æœªçŸ¥'}</div>`;
                } else {
                    html += '<div class="status warn">âš ï¸ æ— æ´»è·ƒä¼šè¯</div>';
                }
            } else {
                html += '<div class="status error">âŒ Clerk SDK æœªåŠ è½½</div>';
            }

            div.innerHTML = html;
        }

        function checkUrlParams() {
            const div = document.getElementById('url-params');
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');

            let html = '';
            if (sessionParam) {
                html += '<div class="status ok">âœ… æ£€æµ‹åˆ°sessionå‚æ•°</div>';
                html += `<div>Tokené•¿åº¦: ${sessionParam.length} å­—ç¬¦</div>`;

                // å°è¯•è§£æJWT
                try {
                    const tokenParts = sessionParam.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        html += '<div class="status ok">âœ… JWTæ ¼å¼æ­£ç¡®</div>';
                        html += `<div>ç”¨æˆ·ID: ${payload.sub || 'æœªçŸ¥'}</div>`;
                        html += `<div>é‚®ç®±: ${payload.email || 'æœªçŸ¥'}</div>`;
                        html += `<div>ä¼šè¯ID: ${payload.sid || 'æœªçŸ¥'}</div>`;

                        // æ£€æŸ¥è¿‡æœŸæ—¶é—´
                        if (payload.exp) {
                            const expDate = new Date(payload.exp * 1000);
                            const now = new Date();
                            if (expDate > now) {
                                html += `<div class="status ok">âœ… Tokenæœªè¿‡æœŸ (${expDate.toLocaleString()})</div>`;
                            } else {
                                html += `<div class="status error">âŒ Tokenå·²è¿‡æœŸ (${expDate.toLocaleString()})</div>`;
                            }
                        }
                    } else {
                        html += '<div class="status error">âŒ JWTæ ¼å¼é”™è¯¯</div>';
                    }
                } catch (error) {
                    html += '<div class="status error">âŒ JWTè§£æå¤±è´¥</div>';
                    log(`JWTè§£æé”™è¯¯: ${error.message}`, 'error');
                }
            } else {
                html += '<div class="status warn">âš ï¸ æœªæ£€æµ‹åˆ°sessionå‚æ•°</div>';
            }

            div.innerHTML = html;
        }

        function runFullDiagnostic() {
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'success');

            checkLocalStorage();
            checkClerkStatus();
            checkUrlParams();

            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        function clearLocalStorage() {
            try {
                const keysToRemove = Object.keys(localStorage).filter(key =>
                    key.includes('clerk') || key.includes('auth')
                );

                keysToRemove.forEach(key => localStorage.removeItem(key));

                log(`ğŸ§¹ æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${keysToRemove.length} ä¸ªé”®`, 'success');

                setTimeout(() => {
                    runFullDiagnostic();
                }, 1000);
            } catch (error) {
                log(`æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateCrossModule() {
            log('ğŸ”„ æ¨¡æ‹Ÿè·¨æ¨¡å—è·³è½¬...', 'info');

            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„session tokenå¯ä»¥ä¼ é€’
            try {
                const clerkEnv = localStorage.getItem('__clerk_environment');
                if (clerkEnv) {
                    const data = JSON.parse(clerkEnv);
                    if (data.session?.id) {
                        const mockUrl = `/quiz/?session=${encodeURIComponent(data.session.id)}`;
                        log(`ğŸ“‹ æ¨¡æ‹Ÿè·³è½¬URL: ${mockUrl}`, 'info');
                        log('â„¹ï¸ åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ­¤URLè¿›è¡Œæµ‹è¯•', 'info');
                        window.open(mockUrl, '_blank');
                        return;
                    }
                }

                log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„session tokenè¿›è¡Œæ¨¡æ‹Ÿ', 'warn');
            } catch (error) {
                log(`æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            log('ğŸ” è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            runFullDiagnostic();
        });

        // ç›‘å¬storageå˜åŒ–
        window.addEventListener('storage', (e) => {
            if (e.key && e.key.includes('clerk')) {
                log(`ğŸ“¦ æ£€æµ‹åˆ°localStorageå˜åŒ–: ${e.key}`, 'info');
                runFullDiagnostic();
            }
        });
    </script>
</body>
</html>